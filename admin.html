<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN | HAZEL (FIXED)</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.6/Sortable.min.js"></script>

    <style>
        /* ========== Swiss Editorial CMS Theme - Premium Design ========== */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Space+Grotesk:wght@300;400;500;700&display=swap');

        :root {
            --bg: #ffffff;
            --sidebar-bg: #fcfcfc;
            --text: #000000;
            --text-muted: #999999;
            --border: #eeeeee;
            --border-heavy: #000000;
            --accent: #000000;
            --danger: #ff0000;
            --panel: #fdfdfd;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Space Grotesk', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            line-height: 1.4;
        }

        /* ===== Layout: Management Portal ===== */
        #app {
            display: flex;
            min-height: 100vh;
        }

        /* ===== Sidebar (Swiss Style) ===== */
        aside {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 60px 40px;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 60px;
        }

        .side-logo {
            font-family: var(--font-serif);
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
            margin: 0;
        }

        .side-logo span {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--text-muted);
            margin-top: 10px;
            font-family: var(--font-sans);
            font-weight: 400;
        }

        .nav-vertical {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-serif);
            font-size: 24px;
            text-align: left;
            cursor: pointer;
            padding: 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text);
            transform: translateX(5px);
        }

        .tab-btn.active {
            color: var(--text);
            font-style: italic;
            font-weight: 600;
        }

        .tab-btn.active::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            width: 10px;
            height: 1px;
            background: var(--text);
        }

        /* ===== Main Content Area ===== */
        main {
            flex: 1;
            margin-left: 300px;
            padding: 80px 10%;
            background: #ffffff;
        }

        .page-title {
            font-family: var(--font-serif);
            font-size: 64px;
            font-weight: 400;
            margin-bottom: 60px;
            border-bottom: 2px solid var(--text);
            padding-bottom: 20px;
        }

        .section-title {
            font-family: var(--font-serif);
            font-size: 32px;
            font-weight: 600;
            margin: 60px 0 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .section-title span {
            font-family: var(--font-sans);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }

        /* ===== Forms (Swiss Minimalist) ===== */
        .form-group {
            margin-bottom: 40px;
            background: var(--panel);
            padding: 0px 0px 40px;
            border-bottom: 1px solid var(--border);
        }

        label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea {
            width: 100%;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 15px 0;
            border-left: none;
            border-right: none;
            border-top: none;
            font-size: 18px;
            font-family: var(--font-serif);
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-bottom-color: var(--text);
        }

        /* ===== Buttons ===== */
        .btn {
            background: var(--text);
            color: #fff;
            border: none;
            padding: 18px 30px;
            font-family: var(--font-sans);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #333;
            letter-spacing: 4px;
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: #fff;
            letter-spacing: 2px;
        }

        /* ===== Project List / Gallery ===== */
        .project-item {
            border-bottom: 1px solid var(--text);
            padding: 60px 0;
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        .img-thumb-container {
            border: 1px solid var(--border);
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .img-thumb-container:hover {
            border-color: var(--text);
        }

        .img-thumb-container img {
            width: 100%;
            height: 120px;
            /* Smaller height for dense grid */
            object-fit: contain;
            /* Show full image, don't crop */
            background: #f5f5f5;
            /* Light bg for aspect ratio padding */
            transition: all 0.3s ease;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            /* ~5-6 columns on desktop */
            gap: 15px;
            /* Tighter gap */
        }

        /* Drag & Drop States ‚Äî SortableJS */
        .img-thumb-container {
            cursor: grab;
            transition: transform 0.2s ease, opacity 0.2s ease, box-shadow 0.2s ease;
        }

        .img-thumb-container:active {
            cursor: grabbing;
        }

        /* SortableJS: the ghost element (placeholder in original position) */
        .sortable-ghost {
            opacity: 0.15;
            transform: scale(0.95);
            border: 2px dashed var(--text-muted) !important;
            background: var(--border) !important;
        }

        /* SortableJS: the dragged element under cursor */
        .sortable-drag {
            opacity: 1 !important;
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.18);
            z-index: 999;
            border: 2px solid var(--text) !important;
        }

        /* SortableJS: the chosen element before drag starts */
        .sortable-chosen {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        /* Image Remove Button */
        .img-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: #fff;
            border: none;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 4px;
        }

        .img-thumb-container:hover .img-remove {
            opacity: 1;
        }

        /* Image Caption Input */
        .image-caption-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            padding: 8px 0;
            margin-top: 10px;
            font-family: var(--font-sans);
        }

        .image-caption-input:focus {
            outline: none;
            border-bottom-color: var(--text);
        }

        /* Drag Hint */
        .drag-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 10px;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .drag-hint svg {
            flex-shrink: 0;
        }

        /* Language Toggle */
        .lang-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            display: flex;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .lang-toggle button {
            background: transparent;
            border: none;
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-sans);
        }

        .lang-toggle button.active {
            background: var(--text);
            color: #fff;
        }

        .lang-toggle button:not(.active) {
            color: var(--text-muted);
        }

        .lang-toggle button:not(.active):hover {
            background: var(--border);
        }

        /* ===== Sticky Footer Action ===== */
        .sticky-actions {
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 100;
        }

        .btn-save-all {
            box-shadow: 20px 20px 0px rgba(0, 0, 0, 0.1);
        }

        /* ===== Login Overlay (Swiss Minimal) ===== */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        #login-overlay h2 {
            font-family: var(--font-serif);
            font-size: 80px;
            font-weight: 400;
            margin: 0;
        }

        #login-overlay input {
            width: 300px;
            text-align: center;
            font-size: 24px;
            border-bottom: 2px solid #000;
        }

        /* ===== Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #fff;
        }

        ::-webkit-scrollbar-thumb {
            background: #000;
        }

        /* FORCE SCROLL LAYOUT */
        .tab-content {
            display: block !important;
            padding-top: 60px;
            padding-bottom: 60px;
            scroll-margin-top: 40px;
            border-top: 1px solid #eee;
        }

        /* Override specific active tab logic since all are visible */
        .tab-content:first-of-type {
            border-top: none;
            padding-top: 0;
        }

        html {
            scroll-behavior: smooth;
        }

        /* Fix scroll container if there is one */
        main {
            height: 100vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        /* ========== Visual Layout Editor ========== */
        .ve-container {
            margin-top: 10px;
        }

        .ve-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 0;
        }

        .ve-tab {
            padding: 10px 24px;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
            border: 1px solid #ddd;
            border-bottom: none;
            background: #f5f5f5;
            color: #999;
            cursor: pointer;
            text-transform: uppercase;
            border-radius: 8px 8px 0 0;
            transition: all 0.2s;
        }

        .ve-tab.active {
            background: #fff;
            color: #333;
            border-bottom: 1px solid #fff;
            margin-bottom: -1px;
            z-index: 1;
        }

        .ve-tab[data-mode="desktop"].active {
            color: #3a7bd5;
        }

        .ve-tab[data-mode="mobile"].active {
            color: #2e7d32;
        }

        .ve-workspace {
            display: flex;
            gap: 16px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 8px 8px 8px;
            padding: 16px;
            min-height: 400px;
        }

        /* Canvas area */
        .ve-canvas-wrap {
            flex: 1;
            position: relative;
            background: #f8f8f8;
            border-radius: 6px;
            overflow: hidden;
            border: 1px solid #eee;
        }

        .ve-canvas {
            position: relative;
            width: 100%;
            padding-bottom: 52.5%;
            /* ~16:8.4 ratio matching actual 100vh - header */
            background: #fff;
            overflow: hidden;
        }

        /* Simulated header bar on Desktop canvas */
        .ve-canvas::before {
            content: 'Hazel Kahlil';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 36px;
            background: #fff;
            border-bottom: 1px solid #eee;
            z-index: 20;
            display: flex;
            align-items: center;
            padding: 0 12px;
            font-family: var(--font-serif, Georgia, serif);
            font-size: 11px;
            letter-spacing: 0.5px;
            color: #333;
            pointer-events: none;
        }

        .ve-canvas.mobile-mode {
            width: 320px;
            padding-bottom: 0;
            min-height: 560px;
            height: 560px;
            max-height: 560px;
            margin: 0 auto;
            background: #fff;
            border: 2px solid #333;
            border-radius: 28px;
            padding: 44px 16px 32px;
            box-sizing: border-box;
            overflow-y: auto;
            overflow-x: hidden;
            position: relative;
        }

        .ve-canvas.mobile-mode::before {
            content: '';
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 5px;
            background: #ddd;
            border-radius: 3px;
            z-index: 10;
        }

        .ve-canvas.mobile-mode::after {
            content: 'Hazel Kahlil';
            position: absolute;
            top: 26px;
            left: 16px;
            font-family: var(--font-serif, Georgia, serif);
            font-size: 9px;
            color: #333;
            pointer-events: none;
            z-index: 10;
        }

        /* Desktop draggable images */
        .ve-img {
            position: absolute;
            cursor: grab;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: box-shadow 0.2s;
            border: 2px solid transparent;
            border-radius: 2px;
        }

        .ve-img:hover {
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .ve-img.selected {
            border-color: #3a7bd5;
            box-shadow: 0 0 0 2px rgba(58, 123, 213, 0.3);
        }

        .ve-img.dragging {
            cursor: grabbing;
            z-index: 100;
            opacity: 0.9;
        }

        .ve-img img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
            display: block;
        }

        .ve-img-label {
            position: absolute;
            top: -20px;
            left: 0;
            font-size: 10px;
            font-weight: 700;
            color: #fff;
            background: rgba(0, 0, 0, 0.6);
            padding: 2px 6px;
            border-radius: 3px;
            pointer-events: none;
            white-space: nowrap;
        }

        /* Resize handle */
        .ve-resize {
            position: absolute;
            bottom: -4px;
            right: -4px;
            width: 12px;
            height: 12px;
            background: #3a7bd5;
            border: 2px solid #fff;
            border-radius: 2px;
            cursor: nwse-resize;
            z-index: 10;
            display: none;
        }

        .ve-img.selected .ve-resize {
            display: block;
        }

        /* Snap guide lines */
        .ve-guide {
            position: absolute;
            z-index: 50;
            pointer-events: none;
            display: none;
        }

        .ve-guide.horizontal {
            left: 0;
            right: 0;
            height: 0;
            border-top: 1px dashed rgba(255, 50, 50, 0.6);
        }

        .ve-guide.vertical {
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 1px dashed rgba(255, 50, 50, 0.6);
        }

        .ve-guide.active {
            display: block;
        }

        .ve-guide-label {
            position: absolute;
            font-size: 9px;
            color: #e53935;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 4px;
            border-radius: 2px;
            pointer-events: none;
        }

        .ve-guide.horizontal .ve-guide-label {
            top: -1px;
            right: 4px;
        }

        .ve-guide.vertical .ve-guide-label {
            left: 2px;
            top: 4px;
        }

        /* Fixed grid lines (faint) */
        .ve-grid-line {
            position: absolute;
            z-index: 1;
            pointer-events: none;
        }

        .ve-grid-line.horizontal {
            left: 0;
            right: 0;
            height: 0;
            border-top: 1px dotted rgba(0, 0, 0, 0.06);
        }

        .ve-grid-line.vertical {
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 1px dotted rgba(0, 0, 0, 0.06);
        }

        /* Properties Panel */
        .ve-props {
            width: 220px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .ve-props-title {
            font-size: 11px;
            font-weight: 700;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .ve-props-card {
            background: #f8f9fa;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            padding: 12px;
        }

        .ve-props-card label {
            font-size: 10px;
            color: #888;
            margin-bottom: 2px;
            display: block;
            font-family: var(--font-sans);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .ve-props-card input[type="number"],
        .ve-props-card input[type="text"],
        .ve-props-card select {
            width: 100%;
            padding: 6px 8px;
            font-size: 13px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            text-align: center;
            font-family: var(--font-mono, monospace);
        }

        .ve-props-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
        }

        .ve-prop-hint {
            font-size: 9px;
            color: #aaa;
            margin-top: 8px;
        }

        /* Image Strip */
        .ve-strip {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            padding: 12px;
            background: #f8f8f8;
            border: 1px solid #eee;
            border-radius: 6px;
            align-items: flex-end;
            flex-wrap: wrap;
        }

        .ve-strip-item {
            width: 80px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 4px;
            padding: 4px;
            transition: all 0.2s;
        }

        .ve-strip-item:hover {
            border-color: #ccc;
        }

        .ve-strip-item.selected {
            border-color: #3a7bd5;
            background: #eef4fc;
        }

        .ve-strip-item img {
            width: 100%;
            height: 56px;
            object-fit: cover;
            border-radius: 2px;
            background: #eee;
            display: block;
        }

        .ve-strip-item span {
            display: block;
            font-size: 9px;
            color: #999;
            margin-top: 3px;
            font-weight: 700;
        }

        /* Mobile editor cards */
        .ve-mobile-card {
            position: absolute;
            cursor: grab;
            user-select: none;
            border: 2px solid transparent;
            border-radius: 4px;
            transition: border-color 0.2s;
        }

        .ve-mobile-card:hover {
            border-color: #b8dab8;
        }

        .ve-mobile-card.selected {
            border-color: #2e7d32;
        }

        .ve-mobile-card img {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 2px;
            filter: grayscale(100%);
            background: #eee;
        }

        .ve-mobile-card .ve-mobile-label {
            position: absolute;
            top: -16px;
            font-size: 9px;
            font-weight: 700;
            color: #2e7d32;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 4px;
            border-radius: 2px;
        }

        .ve-mobile-card[data-col="left"] {
            /* positioned via JS */
        }

        .ve-mobile-card[data-col="right"] {
            /* positioned via JS */
        }

        .ve-mobile-card img {
            width: 100%;
            height: auto;
            display: block;
            filter: grayscale(100%);
            border-radius: 1px;
        }

        .ve-mobile-caption {
            font-size: 6px;
            color: #999;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-top: 2px;
            pointer-events: none;
        }

        .ve-mobile-card[data-col="left"] .ve-mobile-caption {
            text-align: left;
        }

        .ve-mobile-card[data-col="right"] .ve-mobile-caption {
            text-align: right;
        }

        /* Mobile resize handle (horizontal) */
        .ve-mobile-resize {
            position: absolute;
            top: 50%;
            right: -6px;
            width: 8px;
            height: 24px;
            background: #2e7d32;
            border: 2px solid #fff;
            border-radius: 3px;
            cursor: ew-resize;
            transform: translateY(-50%);
            z-index: 10;
            display: none;
        }

        .ve-mobile-card.selected .ve-mobile-resize {
            display: block;
        }

        /* Mobile alignment guides */
        .ve-mobile-guide {
            position: absolute;
            z-index: 50;
            pointer-events: none;
            display: none;
        }

        .ve-mobile-guide.horizontal {
            left: 0;
            right: 0;
            height: 0;
            border-top: 1px dashed rgba(46, 125, 50, 0.6);
        }

        .ve-mobile-guide.vertical {
            top: 0;
            bottom: 0;
            width: 0;
            border-left: 1px dashed rgba(46, 125, 50, 0.6);
        }

        .ve-mobile-guide.active {
            display: block;
        }

        .ve-mobile-guide-label {
            position: absolute;
            font-size: 8px;
            color: #2e7d32;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 3px;
            border-radius: 2px;
            pointer-events: none;
            white-space: nowrap;
        }

        .ve-mobile-guide.horizontal .ve-mobile-guide-label {
            top: -1px;
            right: 2px;
        }

        .ve-mobile-guide.vertical .ve-mobile-guide-label {
            left: 2px;
            top: 2px;
        }

        .ve-mobile-card.dragging {
            cursor: grabbing;
            z-index: 100;
            opacity: 0.85;
        }

        /* Toast Notification System */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            padding: 12px 20px;
            font-size: 12px;
            font-weight: 600;
            border-radius: 6px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 200px;
        }

        .toast.success {
            background: #1a1a1a;
            color: #fff;
        }

        .toast.error {
            background: #c62828;
            color: #fff;
        }

        .toast.info {
            background: #fff;
            color: #333;
            border: 1px solid #ddd;
        }

        @keyframes toastIn {
            from {
                transform: translateX(100px);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes toastOut {
            to {
                transform: translateX(100px);
                opacity: 0;
            }
        }

        /* Keyboard hints */
        .ve-keyboard-hint {
            font-size: 10px;
            color: #aaa;
            padding: 8px 0;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }

        .ve-keyboard-hint kbd {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 1px 5px;
            font-size: 10px;
            font-family: var(--font-mono, monospace);
        }

        /* === Phase 1 Enhancements === */
        .photo-count-badge {
            font-size: 11px;
            color: #999;
            font-weight: 400;
            font-family: var(--font-sans);
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        .img-set-cover {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            border: none;
            font-size: 8px;
            padding: 3px 6px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
            border-radius: 3px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-family: var(--font-sans);
        }

        .img-thumb-container:hover .img-set-cover {
            opacity: 0.7;
        }

        .img-set-cover:hover {
            opacity: 1 !important;
            background: #3a7bd5;
        }

        .img-thumb-container.is-cover {
            border-color: #3a7bd5;
            box-shadow: 0 0 0 2px rgba(58, 123, 213, 0.3);
        }

        .img-thumb-container.is-cover::after {
            content: '‚òÖ COVER';
            position: absolute;
            bottom: 36px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
            font-weight: 700;
            color: #3a7bd5;
            background: rgba(255, 255, 255, 0.9);
            padding: 1px 6px;
            border-radius: 3px;
            letter-spacing: 0.5px;
            pointer-events: none;
        }

        .upload-progress {
            position: fixed;
            top: 0;
            left: 300px;
            right: 0;
            height: 3px;
            background: #eee;
            z-index: 9999;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .upload-progress-bar {
            height: 100%;
            background: #000;
            transition: width 0.3s ease;
            border-radius: 0 2px 2px 0;
            width: 0%;
        }

        .unsaved-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #ff4444;
            border-radius: 50%;
            margin-left: 8px;
            animation: pulse-dot 1.5s ease-in-out infinite;
            vertical-align: middle;
        }

        @keyframes pulse-dot {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        .shortcut-hint {
            font-size: 9px;
            color: #bbb;
            margin-top: 6px;
            text-align: center;
        }

        .shortcut-hint kbd {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 3px;
            padding: 0 4px;
            font-size: 9px;
            font-family: var(--font-mono, monospace);
        }

        .gallery-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .gallery-toolbar label {
            margin: 0;
        }
    </style>
</head>

<body>
    <div class="upload-progress" id="upload-progress">
        <div class="upload-progress-bar" id="upload-progress-bar"></div>
    </div>

    <!-- LOGIN -->
    <div id="login-overlay">
        <h2>ACCESS</h2>
        <input type="password" id="password-input" placeholder="Password"
            onkeypress="if(event.key==='Enter')checkAuth()">
        <button class="btn" onclick="checkAuth()">Enter Portal</button>
        <p id="login-error" style="display:none; color: red; font-size: 14px;">Access Denied</p>
    </div>

    <!-- MAIN APP -->
    <div id="app" style="display:none;">

        <!-- Language Toggle -->
        <div class="lang-toggle">
            <button class="active" onclick="setLang('en')">EN</button>
            <button onclick="setLang('zh')">‰∏≠</button>
        </div>

        <aside>
            <div class="side-logo">
                Hazel.
                <span>Management Suite</span>
            </div>

            <nav class="nav-vertical">
                <button class="tab-btn"
                    onclick="document.getElementById('tab-home').scrollIntoView({behavior: 'smooth', block: 'start'})">Index</button>
                <button class="tab-btn"
                    onclick="document.getElementById('tab-portfolios').scrollIntoView({behavior: 'smooth', block: 'start'})">Portfolios</button>
                <button class="tab-btn"
                    onclick="document.getElementById('tab-info').scrollIntoView({behavior: 'smooth', block: 'start'})">Info</button>
                <button class="tab-btn"
                    onclick="document.getElementById('tab-contact').scrollIntoView({behavior: 'smooth', block: 'start'})">Contact</button>
            </nav>

            <div style="margin-top: auto;">
                <a href="index.html" target="_blank"
                    style="text-decoration: none; color: #000; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">View
                    Live Site ‚Üó</a>
            </div>
        </aside>

        <main>
            <div class="page-title">Index</div>
            <div class="container">

                <!-- TAB: HOME -->
                <div id="tab-home" class="tab-content active">
                    <div class="section-title"><span>Global Settings</span></div>
                    <div class="form-group">
                        <div class="row-inputs">
                            <div>
                                <label>Site Main Title</label>
                                <input type="text" id="site-title" oninput="updateSiteData('title', this.value)">
                            </div>
                            <div>
                                <label>Footer Copyright</label>
                                <input type="text" id="site-copyright"
                                    oninput="updateSiteData('copyright', this.value)">
                            </div>
                        </div>

                        <!-- New Header Socials -->
                        <div class="row-inputs" style="margin-top:10px;">
                            <div>
                                <label>Header: Instagram URL</label>
                                <input type="text" id="header-ig"
                                    oninput="updateSiteData('header_social_instagram', this.value)">
                            </div>
                        </div>
                        <div class="row-inputs" style="margin-top:10px;">
                            <div>
                                <label>Header: Link URL (Chain)</label>
                                <input type="text" id="header-link"
                                    oninput="updateSiteData('header_social_link', this.value)">
                            </div>
                            <div>
                                <label>Header: Email Address</label>
                                <input type="text" id="header-email"
                                    oninput="updateSiteData('header_social_email', this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="section-title"><span>Home Hero Images</span></div>
                    <div class="form-group">
                        <div id="home-visual-editor"></div>
                    </div>
                </div>

                <!-- TAB: PORTFOLIOS -->
                <div id="tab-portfolios" class="tab-content">
                    <button class="btn btn-block"
                        style="margin-bottom:20px; border:1px dashed #666; background:transparent; color:#888;"
                        onclick="addNewProject()">+ NEW PROJECT</button>
                    <div id="projects-list"></div>
                </div>

                <!-- TAB: INFO (BIO) -->
                <div id="tab-info" class="tab-content">
                    <div class="section-title"><span>Biography Content</span></div>
                    <div class="form-group">
                        <label>Main Text (Paragraphs are preserved)</label>
                        <textarea id="site-bio" oninput="updateSiteData('bio', this.value)"></textarea>
                    </div>

                    <details>
                        <summary class="section-title" style="cursor:pointer; user-select:none;">Layout Control ‚ñº
                        </summary>
                        <div class="form-group">
                            <div class="row-inputs">
                                <div>
                                    <label>Padding Top (px)</label>
                                    <input type="number" id="bio-top" placeholder="Default: 40"
                                        oninput="updateBioLayout('top', this.value)">
                                </div>
                                <div>
                                    <label>Padding Left (px)</label>
                                    <input type="number" id="bio-left" placeholder="Default: 60"
                                        oninput="updateBioLayout('padding_left', this.value)">
                                </div>
                                <div>
                                    <label>Width (%)</label>
                                    <input type="number" id="bio-width" placeholder="Default: 60"
                                        oninput="updateBioLayout('width', this.value)">
                                </div>
                                <div>
                                    <label>Max Width (px)</label>
                                    <input type="number" id="bio-max-width" placeholder="Default: 600"
                                        oninput="updateBioLayout('max_width', this.value)">
                                </div>
                            </div>
                            <p style="font-size:10px; color:#666; margin-top:10px;">Adjust these values to position the
                                text block exactly where you want it. Clear to reset to defaults.</p>
                        </div>
                    </details>
                </div>

                <!-- TAB: CONTACT -->
                <div id="tab-contact" class="tab-content">
                    <div class="section-title"><span>Contact Details</span></div>
                    <div class="form-group">
                        <div id="contact-list-container" style="display:flex; flex-direction:column; gap:10px;"></div>
                        <button class="btn" onclick="addContactItem()" style="margin-top:10px;">+ Add Contact
                            Row</button>
                    </div>

                    <details>
                        <summary class="section-title" style="cursor:pointer; user-select:none;">Layout Control ‚ñº
                        </summary>
                        <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                            <div>
                                <label style="color:#aaa;">Info Side (Left)</label>
                                <div class="row-inputs" style="flex-direction:column; gap:5px;">
                                    <div><label style="font-size:9px;">Top px</label><input type="number"
                                            id="c-info-top" placeholder="Def: 40"
                                            oninput="updateContactLayout('info', 'top', this.value)"
                                            style="padding:4px; font-size:11px;"></div>
                                    <div><label style="font-size:9px;">Left px</label><input type="number"
                                            id="c-info-left" placeholder="Def: 0"
                                            oninput="updateContactLayout('info', 'left', this.value)"
                                            style="padding:4px; font-size:11px;"></div>
                                    <div><label style="font-size:9px;">Width %</label><input type="number"
                                            id="c-info-width" placeholder="Def: 45"
                                            oninput="updateContactLayout('info', 'width', this.value)"
                                            style="padding:4px; font-size:11px;"></div>
                                </div>
                            </div>
                            <div>
                                <label style="color:#aaa;">Gallery Side (Right)</label>
                                <div class="row-inputs" style="flex-direction:column; gap:5px;">
                                    <div><label style="font-size:9px;">Top px</label><input type="number" id="c-gal-top"
                                            placeholder="Def: 40"
                                            oninput="updateContactLayout('gallery', 'top', this.value)"
                                            style="padding:4px; font-size:11px;"></div>
                                    <div><label style="font-size:9px;">Margin Left px</label><input type="number"
                                            id="c-gal-left" placeholder="Def: 0"
                                            oninput="updateContactLayout('gallery', 'left', this.value)"
                                            style="padding:4px; font-size:11px;"></div>
                                    <div><label style="font-size:9px;">Width %</label><input type="number"
                                            id="c-gal-width" placeholder="Def: 50"
                                            oninput="updateContactLayout('gallery', 'width', this.value)"
                                            style="padding:4px; font-size:11px;"></div>
                                </div>
                            </div>
                        </div>
                    </details>

                    <div class="section-title">Contact Images (Right Side)</div>
                    <div class="form-group">
                        <!-- Mode Toggle -->
                        <div style="margin-bottom:15px; padding:15px; background:#fff; border:1px solid #eee;">
                            <label style="display:flex; align-items:center; cursor:pointer;">
                                <input type="checkbox" id="contact-random-toggle"
                                    onchange="toggleContactImageMode(this.checked)"
                                    style="width:18px; height:18px; margin-right:12px; cursor:pointer; accent-color:#000;">
                                <span id="contact-mode-label" style="font-size:12px; font-weight:500;">üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè</span>
                            </label>
                            <div id="contact-mode-hint" style="font-size:10px; color:#999; margin-top:8px;">
                                ÂºÄÂêØÂêéÊØèÊ¨°Âà∑Êñ∞È°µÈù¢ÊòæÁ§∫ÈöèÊú∫ÂõæÁâáÔºõÂÖ≥Èó≠Âêé‰ΩøÁî®‰∏ãÊñπÊåáÂÆöÁöÑÂõ∫ÂÆöÂõæÁâá
                            </div>
                        </div>

                        <!-- Fixed Images Section (shown when random is off) -->
                        <div id="contact-fixed-section">
                            <label style="margin-bottom:10px; font-size:10px; color:#888;">Âõ∫ÂÆöÂõæÁâáËÆæÁΩÆÔºà‰ªÖÂú®ÂÖ≥Èó≠ÈöèÊú∫Ê®°ÂºèÊó∂ÁîüÊïàÔºâ</label>
                            <div id="contact-images-list" style="display:flex; gap:10px;"></div>
                        </div>
                    </div>
                </div>

            </div>

        </main>

        <!-- FOOTER -->
        <div class="sticky-actions">
            <button class="btn btn-save-all" id="btn-save" onclick="saveData()">SAVE CHANGES</button>
            <button class="btn btn-save-all" onclick="publishData()"
                style="background: #fff; color: #000; border: 1px solid #000; margin-left:10px;">
                PUBLISH TO LIVE
            </button>
            <div class="shortcut-hint"><kbd>‚åòS</kbd> Save &nbsp; <kbd>‚åò‚áßP</kbd> Publish</div>
        </div>
    </div>

    <script>
        // ... (data init)

        async function publishData() {
            const btn = document.querySelectorAll('.btn-save-all')[1]; // The second button
            const originalText = btn.textContent;

            if (!confirm('This will push all changes to the live website (GitHub). Continue?')) return;

            btn.textContent = 'PUBLISHING...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/publish', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    showToast('‚úÖ ' + result.message, 'success');
                } else {
                    showToast('‚ùå Publish Failed: ' + result.message, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('‚ùå Error publishing: ' + error.message, 'error');
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        let data = { site: {}, projects: [] };
        let currentLang = 'en';

        // i18n Translations
        const i18n = {
            en: {
                // Sidebar
                'nav.index': 'Index',
                'nav.collections': 'Portfolios',
                'nav.biography': 'Info',
                'nav.dialogue': 'Contact',
                'nav.viewSite': 'View Live Site ‚Üó',
                'logo.subtitle': 'Management Suite',
                // Page Titles
                'page.index': 'Index',
                'page.collections': 'Portfolios',
                'page.biography': 'Info',
                'page.dialogue': 'Contact',
                // Section Titles
                'section.globalSettings': 'Global Settings',
                'section.heroImages': 'Home Hero Images',
                'section.bioContent': 'Biography Content',
                'section.layoutControl': 'Layout Control',
                'section.contactDetails': 'Contact Details',
                'section.contactImages': 'Contact Images',
                // Labels
                'label.siteTitle': 'Site Main Title',
                'label.copyright': 'Footer Copyright',
                'label.instagram': 'Header: Instagram URL',
                'label.linkUrl': 'Header: Link URL (Chain)',
                'label.email': 'Header: Email Address',
                'label.bioText': 'Main Text (Paragraphs are preserved)',
                'label.paddingTop': 'Padding Top (px)',
                'label.paddingLeft': 'Padding Left (px)',
                'label.width': 'Width (%)',
                'label.maxWidth': 'Max Width (px)',
                // Buttons
                'btn.save': 'SAVE CHANGES',
                'btn.publish': 'PUBLISH TO LIVE',
                'btn.newProject': '+ NEW PROJECT',
                'btn.addContact': '+ Add Contact Row',
                'btn.enter': 'Enter Portal',
                // Misc
                'hint.dragReorder': 'Drag to reorder images',
                'login.title': 'ACCESS',
                'login.error': 'Access Denied'
            },
            zh: {
                // Sidebar
                'nav.index': 'È¶ñÈ°µ',
                'nav.collections': '‰ΩúÂìÅÈõÜ',
                'nav.biography': 'ÁÆÄ‰ªã',
                'nav.dialogue': 'ËÅîÁ≥ª',
                'nav.viewSite': 'Êü•ÁúãÁΩëÁ´ô ‚Üó',
                'logo.subtitle': 'ÂÜÖÂÆπÁÆ°ÁêÜÁ≥ªÁªü',
                // Page Titles
                'page.index': 'È¶ñÈ°µËÆæÁΩÆ',
                'page.collections': '‰ΩúÂìÅÈõÜÁÆ°ÁêÜ',
                'page.biography': '‰∏™‰∫∫ÁÆÄ‰ªã',
                'page.dialogue': 'ËÅîÁ≥ªÊñπÂºè',
                // Section Titles
                'section.globalSettings': 'ÂÖ®Â±ÄËÆæÁΩÆ',
                'section.heroImages': 'È¶ñÈ°µÂ§ßÂõæ',
                'section.bioContent': 'ÁÆÄ‰ªãÂÜÖÂÆπ',
                'section.layoutControl': 'Â∏ÉÂ±ÄÊéßÂà∂',
                'section.contactDetails': 'ËÅîÁ≥ª‰ø°ÊÅØ',
                'section.contactImages': 'ËÅîÁ≥ªÈ°µÂõæÁâá',
                // Labels
                'label.siteTitle': 'ÁΩëÁ´ôÊ†áÈ¢ò',
                'label.copyright': 'Â∫ïÈÉ®ÁâàÊùÉ',
                'label.instagram': 'Instagram ÈìæÊé•',
                'label.linkUrl': 'ÈìæÊé•Âú∞ÂùÄ',
                'label.email': 'ÈÇÆÁÆ±Âú∞ÂùÄ',
                'label.bioText': 'ÁÆÄ‰ªãÊ≠£ÊñáÔºà‰øùÁïôÊÆµËêΩÊ†ºÂºèÔºâ',
                'label.paddingTop': 'È°∂ÈÉ®Èó¥Ë∑ù (px)',
                'label.paddingLeft': 'Â∑¶‰æßÈó¥Ë∑ù (px)',
                'label.width': 'ÂÆΩÂ∫¶ (%)',
                'label.maxWidth': 'ÊúÄÂ§ßÂÆΩÂ∫¶ (px)',
                // Buttons
                'btn.save': '‰øùÂ≠òÊõ¥Êîπ',
                'btn.publish': 'ÂèëÂ∏ÉÂà∞Á∫ø‰∏ä',
                'btn.newProject': '+ Êñ∞Âª∫È°πÁõÆ',
                'btn.addContact': '+ Ê∑ªÂä†ËÅîÁ≥ªÊñπÂºè',
                'btn.enter': 'ËøõÂÖ•Á≥ªÁªü',
                // Misc
                'hint.dragReorder': 'ÊãñÊãΩË∞ÉÊï¥È°∫Â∫è',
                'login.title': 'ËÆøÈóÆÈ™åËØÅ',
                'login.error': 'ÂØÜÁ†ÅÈîôËØØ'
            }
        };

        function setLang(lang) {
            currentLang = lang;
            // Update toggle buttons
            document.querySelectorAll('.lang-toggle button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(lang === 'en' ? 'EN' : '‰∏≠'));
            });
            // Apply translations
            applyTranslations();
            localStorage.setItem('adminLang', lang);
        }

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function applyTranslations() {
            // Sidebar Nav
            const navBtns = document.querySelectorAll('.nav-vertical .tab-btn');
            if (navBtns[0]) navBtns[0].textContent = t('nav.index');
            if (navBtns[1]) navBtns[1].textContent = t('nav.collections');
            if (navBtns[2]) navBtns[2].textContent = t('nav.biography');
            if (navBtns[3]) navBtns[3].textContent = t('nav.dialogue');

            // Sidebar Logo Subtitle
            const logoSubtitle = document.querySelector('.side-logo span');
            if (logoSubtitle) logoSubtitle.textContent = t('logo.subtitle');

            // View Site Link
            const viewSiteLink = document.querySelector('aside a[href="index.html"]');
            if (viewSiteLink) viewSiteLink.textContent = t('nav.viewSite');

            // Page Title
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabId = activeTab.id.replace('tab-', '');
                    const titles = { 'home': 'page.index', 'portfolios': 'page.collections', 'info': 'page.biography', 'contact': 'page.dialogue' };
                    pageTitle.textContent = t(titles[tabId] || 'page.index');
                }
            }

            // Save & Publish Buttons
            const footerBtns = document.querySelectorAll('.btn-save-all');
            if (footerBtns[0]) footerBtns[0].textContent = t('btn.save');
            if (footerBtns[1]) footerBtns[1].textContent = t('btn.publish');

            // New Project Button
            const newProjectBtn = document.querySelector('#tab-portfolios .btn-block');
            if (newProjectBtn) newProjectBtn.textContent = t('btn.newProject');

            // Login
            const loginTitle = document.querySelector('#login-overlay h2');
            if (loginTitle) loginTitle.textContent = t('login.title');
            const loginBtn = document.querySelector('#login-overlay .btn');
            if (loginBtn) loginBtn.textContent = t('btn.enter');
        }


        // Performance: Debounce for input handlers
        function debounce(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function checkAuth() {
            if (document.getElementById('password-input').value === 'hazel2026') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'flex';

                // Restore saved language
                const savedLang = localStorage.getItem('adminLang') || 'en';
                setLang(savedLang);

                await loadData();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        async function loadData() {
            try {
                const res = await fetch('/data.json?t=' + Date.now());
                data = await res.json();

                // Init Site Info
                updateField('site-title', data.site.title);
                updateField('site-copyright', data.site.copyright);
                // Header Socials Init
                updateField('header-ig', data.site.header_social_instagram);
                updateField('header-link', data.site.header_social_link);
                updateField('header-email', data.site.header_social_email);
                updateField('site-bio', data.site.bio);

                // Init Bio Layout
                if (!data.site.bio_layout) data.site.bio_layout = {};
                updateField('bio-top', data.site.bio_layout.top);
                updateField('bio-left', data.site.bio_layout.padding_left);
                updateField('bio-width', data.site.bio_layout.width);
                updateField('bio-max-width', data.site.bio_layout.max_width);

                // Init Lists
                if (!data.site.contact_items) data.site.contact_items = [];
                renderContactList();

                // Init Contact Layout & Images
                if (!data.site.contact_info_layout) data.site.contact_info_layout = {};
                if (!data.site.contact_gallery_layout) data.site.contact_gallery_layout = {};
                updateField('c-info-top', data.site.contact_info_layout.top);
                updateField('c-info-left', data.site.contact_info_layout.left);
                updateField('c-info-width', data.site.contact_info_layout.width);

                updateField('c-gal-top', data.site.contact_gallery_layout.top);
                updateField('c-gal-left', data.site.contact_gallery_layout.left);
                updateField('c-gal-width', data.site.contact_gallery_layout.width);

                renderContactImagesEditor();

                if (!data.site.home_images) data.site.home_images = [];
                while (data.site.home_images.length < 5) data.site.home_images.push("");
                if (data.site.home_images.length > 5) data.site.home_images.length = 5;
                renderHomeImagesEditor();

                renderProjects();
            } catch (e) {
                console.error(e);
                alert("Failed to load data.json");
            }
        }

        function updateField(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val || '';
        }

        // --- CORE UPDATE FUNCTIONS ---

        function updateSiteData(key, val) {
            data.site[key] = val;
        }

        function updateBioLayout(key, val) {
            if (!data.site.bio_layout) data.site.bio_layout = {};
            data.site.bio_layout[key] = val;
        }

        // --- HOME VISUAL LAYOUT EDITOR ---

        let veMode = 'desktop'; // 'desktop' | 'mobile'
        let veSelected = 0; // selected image index

        const desktopDefs = [
            { t: 2, l: 8, w: 35 },
            { t: 25, l: 38, w: 22 },
            { t: 6, l: 65, w: 32 },
            { t: 35, l: 12, w: 20 },
            { t: 30, l: 65, w: 26 }
        ];
        const mobileDefs = [
            { col: 'left', w: 62, mt: 0, top: 0, left: 0 },
            { col: 'right', w: 48, mt: 30, top: 16, left: 52 },
            { col: 'left', w: 38, mt: -60, top: 28, left: 0 },
            { col: 'right', w: 52, mt: 30, top: 48, left: 48 },
            { col: 'left', w: 44, mt: -30, top: 60, left: 0 },
        ];
        const MOBILE_SNAP_THRESHOLD = 1.5; // percent
        const SNAP_LINES = [0, 25, 50, 75, 100];
        const SNAP_THRESHOLD = 2; // percent

        function getImgSrc(item) {
            let src = typeof item === 'string' ? item : item.src;
            if (!src) return '';
            if (!src.startsWith('http') && !src.startsWith('/')) src = '/' + src;
            return src + '?t=' + Date.now();
        }

        function ensureObj(index) {
            let c = data.site.home_images[index];
            if (typeof c === 'string') { c = { src: c, style: {} }; data.site.home_images[index] = c; }
            if (!c.style) c.style = {};
            return c;
        }

        function getDesktop(item, i) {
            const d = desktopDefs[i] || { t: 0, l: 0, w: 30 };
            const s = (typeof item === 'object' && item.style) || {};
            return {
                top: parseFloat(s.top) || d.t,
                left: parseFloat(s.left) || d.l,
                width: parseFloat(s.width) || d.w
            };
        }

        function getMobile(item, i) {
            const d = mobileDefs[i] || { col: 'left', w: 50, mt: 0, top: 0, left: 0 };
            if (typeof item === 'string') return { col: d.col, width: d.w, mt: d.mt, top: d.top, left: d.left };
            return {
                col: item.mobile_col || d.col,
                width: item.mobile_width || d.w,
                mt: (item.mobile_mt !== undefined && item.mobile_mt !== null) ? item.mobile_mt : d.mt,
                top: (item.mobile_top !== undefined && item.mobile_top !== null) ? item.mobile_top : d.top,
                left: (item.mobile_left !== undefined && item.mobile_left !== null) ? item.mobile_left : d.left
            };
        }

        // ---- MAIN RENDER ----
        function renderHomeImagesEditor() {
            const root = document.getElementById('home-visual-editor');
            if (!root) return;
            root.innerHTML = '';

            // Tabs
            const tabs = document.createElement('div');
            tabs.className = 've-tabs';
            tabs.innerHTML = `
                <button class="ve-tab ${veMode === 'desktop' ? 'active' : ''}" data-mode="desktop" onclick="veMode='desktop'; renderHomeImagesEditor();">üñ• Desktop Ê°åÈù¢</button>
                <button class="ve-tab ${veMode === 'mobile' ? 'active' : ''}" data-mode="mobile" onclick="veMode='mobile'; renderHomeImagesEditor();">üì± Mobile ÁßªÂä®</button>
            `;
            root.appendChild(tabs);

            // Workspace
            const ws = document.createElement('div');
            ws.className = 've-workspace';
            root.appendChild(ws);

            if (veMode === 'desktop') {
                renderDesktopCanvas(ws);
            } else {
                renderMobileCanvas(ws);
            }

            // Image strip
            renderImageStrip(root);

            // Keyboard hints
            const hints = document.createElement('div');
            hints.className = 've-keyboard-hint';
            hints.innerHTML = `<span>ÊãñÊãΩÂõæÁâáË∞ÉÊï¥‰ΩçÁΩÆ</span> <span>ÊãñÊãΩËßíÊ†áÁº©Êîæ</span> <span><kbd>Shift</kbd> Á¶ÅÁî®Âê∏ÈôÑ</span> <span>ÁÇπÂáªÂõæÁâáÈÄâ‰∏≠ ‚Üí Âè≥‰æßÁ≤æÁ°ÆË∞ÉÊï¥</span>`;
            root.appendChild(hints);
        }

        // ---- DESKTOP CANVAS ----
        function renderDesktopCanvas(ws) {
            const images = data.site.home_images || [];

            // Canvas wrap
            const canvasWrap = document.createElement('div');
            canvasWrap.className = 've-canvas-wrap';
            const canvas = document.createElement('div');
            canvas.className = 've-canvas';
            canvas.id = 've-desktop-canvas';
            canvasWrap.appendChild(canvas);
            ws.appendChild(canvasWrap);

            // Grid lines (faint)
            SNAP_LINES.forEach(pct => {
                if (pct === 0 || pct === 100) return;
                const hLine = document.createElement('div');
                hLine.className = 've-grid-line horizontal';
                hLine.style.top = pct + '%';
                canvas.appendChild(hLine);
                const vLine = document.createElement('div');
                vLine.className = 've-grid-line vertical';
                vLine.style.left = pct + '%';
                canvas.appendChild(vLine);
            });

            // Snap guides (dynamic, hidden by default)
            for (let g = 0; g < 10; g++) {
                const guide = document.createElement('div');
                guide.className = 've-guide ' + (g < 5 ? 'horizontal' : 'vertical');
                guide.id = 've-guide-' + g;
                guide.innerHTML = '<span class="ve-guide-label"></span>';
                canvas.appendChild(guide);
            }

            // Render images ‚Äî offset by header bar (36px = ~5% of canvas height)
            images.forEach((item, i) => {
                if (i >= 5) return;
                const pos = getDesktop(item, i);
                const src = getImgSrc(item);

                const el = document.createElement('div');
                el.className = 've-img' + (i === veSelected ? ' selected' : '');
                // Offset top by simulated header (5%)
                el.style.top = (pos.top + 5) + '%';
                el.style.left = pos.left + '%';
                el.style.width = pos.width + '%';
                el.style.aspectRatio = '4/3';
                el.dataset.idx = i;
                el.innerHTML = `
                    <span class="ve-img-label">#${i + 1}</span>
                    ${src ? `<img src="${src}" draggable="false">` : '<div style="width:100%;height:100%;background:#ddd;display:flex;align-items:center;justify-content:center;color:#999;font-size:11px;">NO IMG</div>'}
                    <div class="ve-resize"></div>
                `;
                canvas.appendChild(el);

                // Click to select
                el.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('ve-resize')) return;
                    veSelected = i;
                    document.querySelectorAll('.ve-img').forEach(v => v.classList.remove('selected'));
                    el.classList.add('selected');
                    document.querySelectorAll('.ve-strip-item').forEach((s, si) => s.classList.toggle('selected', si === i));
                    updateDesktopProps();
                    startDesktopDrag(e, el, i, canvas);
                });

                // Resize handle
                el.querySelector('.ve-resize').addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    veSelected = i;
                    startDesktopResize(e, el, i, canvas);
                });
            });

            // Props panel
            const props = document.createElement('div');
            props.className = 've-props';
            props.id = 've-desktop-props';
            ws.appendChild(props);
            updateDesktopProps();
        }

        function updateDesktopProps() {
            const props = document.getElementById('ve-desktop-props');
            if (!props) return;
            const images = data.site.home_images || [];
            const i = veSelected;
            if (i >= images.length) return;
            const item = images[i];
            const pos = getDesktop(item, i);
            const caption = (typeof item === 'object' && item.caption) || '';

            props.innerHTML = `
                <div class="ve-props-title">Image #${i + 1} Â±ûÊÄß</div>
                <div class="ve-props-card" style="border-color:#c4d9f2;">
                    <div style="font-size:11px; font-weight:700; color:#3a7bd5; margin-bottom:8px;">üñ• DESKTOP</div>
                    <div class="ve-props-row">
                        <div><label>Top %</label><input type="number" value="${pos.top}" min="0" max="100" step="1" oninput="veSetDesktop(${i},'top',this.value)"></div>
                        <div><label>Left %</label><input type="number" value="${pos.left}" min="0" max="100" step="1" oninput="veSetDesktop(${i},'left',this.value)"></div>
                        <div><label>Width %</label><input type="number" value="${pos.width}" min="5" max="80" step="1" oninput="veSetDesktop(${i},'width',this.value)"></div>
                    </div>
                    <div class="ve-prop-hint">ÊàñÁõ¥Êé•Âú®ÁîªÂ∏É‰∏äÊãñÊãΩÂõæÁâá</div>
                </div>
                <div class="ve-props-card">
                    <label>üìç Caption</label>
                    <input type="text" placeholder="‰æã: Kyoto, Japan" value="${caption}" oninput="veSetCaption(${i}, this.value)">
                </div>
                <div class="ve-props-card">
                    <label>‰∏ä‰º†/Êõ¥Êç¢</label>
                    <button class="btn" style="font-size:10px; padding:6px; width:100%; border-radius:4px;" onclick="document.getElementById('ve-upload-${i}').click()">
                        ${(typeof item === 'object' && item.src) || typeof item === 'string' ? 'Êõ¥Êç¢ÂõæÁâá' : '‰∏ä‰º†ÂõæÁâá'}
                    </button>
                    <input type="file" id="ve-upload-${i}" style="display:none" onchange="uploadFile(this, (path) => { ensureObj(${i}).src = path; renderHomeImagesEditor(); })">
                </div>
            `;
        }

        function veSetDesktop(i, key, val) {
            const obj = ensureObj(i);
            obj.style[key] = val;
            // Update canvas element
            const el = document.querySelector(`.ve-img[data-idx="${i}"]`);
            if (el) {
                if (key === 'top') el.style.top = val + '%';
                if (key === 'left') el.style.left = val + '%';
                if (key === 'width') el.style.width = val + '%';
            }
        }

        function veSetCaption(i, val) {
            ensureObj(i).caption = val;
        }

        // ---- DESKTOP DRAG ----
        function startDesktopDrag(e, el, idx, canvas) {
            e.preventDefault();
            el.classList.add('dragging');
            const rect = canvas.getBoundingClientRect();
            const startX = e.clientX, startY = e.clientY;
            const startLeft = parseFloat(el.style.left), startTop = parseFloat(el.style.top);

            function onMove(ev) {
                const dx = ((ev.clientX - startX) / rect.width) * 100;
                const dy = ((ev.clientY - startY) / rect.height) * 100;
                let newLeft = Math.max(0, Math.min(95, startLeft + dx));
                let newTop = Math.max(0, Math.min(95, startTop + dy));

                // Snap (unless Shift held)
                if (!ev.shiftKey) {
                    const snapped = applySnap(newLeft, newTop, parseFloat(el.style.width), idx, canvas);
                    newLeft = snapped.left; newTop = snapped.top;
                } else {
                    hideAllGuides();
                }

                el.style.left = newLeft + '%';
                el.style.top = newTop + '%';
                ensureObj(idx).style.left = Math.round(newLeft);
                ensureObj(idx).style.top = Math.round(newTop);
                updateDesktopProps();
            }
            function onUp() {
                el.classList.remove('dragging');
                hideAllGuides();
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        }

        // ---- DESKTOP RESIZE ----
        function startDesktopResize(e, el, idx, canvas) {
            e.preventDefault();
            const rect = canvas.getBoundingClientRect();
            const startX = e.clientX;
            const startW = parseFloat(el.style.width);

            function onMove(ev) {
                const dx = ((ev.clientX - startX) / rect.width) * 100;
                let newW = Math.max(5, Math.min(80, startW + dx));
                el.style.width = newW + '%';
                ensureObj(idx).style.width = Math.round(newW);
                updateDesktopProps();
            }
            function onUp() {
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        }

        // ---- SNAP LOGIC ----
        function applySnap(left, top, width, idx, canvas) {
            let snappedLeft = left, snappedTop = top;
            let guideIdx = 0;
            hideAllGuides();

            // Edges of this image
            const right = left + width;
            const centerX = left + width / 2;

            // Check vertical snap lines
            SNAP_LINES.forEach(line => {
                // Left edge snap
                if (Math.abs(left - line) < SNAP_THRESHOLD) {
                    snappedLeft = line;
                    showGuide(guideIdx++, 'vertical', line, line + '%');
                }
                // Right edge snap
                if (Math.abs(right - line) < SNAP_THRESHOLD) {
                    snappedLeft = line - width;
                    showGuide(guideIdx++, 'vertical', line, line + '%');
                }
                // Center snap
                if (Math.abs(centerX - line) < SNAP_THRESHOLD) {
                    snappedLeft = line - width / 2;
                    showGuide(guideIdx++, 'vertical', line, line + '%');
                }
            });

            // Check horizontal snap lines
            SNAP_LINES.forEach(line => {
                if (Math.abs(top - line) < SNAP_THRESHOLD) {
                    snappedTop = line;
                    showGuide(guideIdx++, 'horizontal', line, line + '%');
                }
            });

            // Dynamic: snap to other images
            document.querySelectorAll('.ve-img').forEach(other => {
                const oIdx = parseInt(other.dataset.idx);
                if (oIdx === idx || guideIdx >= 10) return;
                const oLeft = parseFloat(other.style.left);
                const oTop = parseFloat(other.style.top);
                // Align tops
                if (Math.abs(top - oTop) < SNAP_THRESHOLD) {
                    snappedTop = oTop;
                    showGuide(guideIdx++, 'horizontal', oTop, 'align #' + (oIdx + 1));
                }
                // Align lefts
                if (Math.abs(left - oLeft) < SNAP_THRESHOLD) {
                    snappedLeft = oLeft;
                    showGuide(guideIdx++, 'vertical', oLeft, 'align #' + (oIdx + 1));
                }
            });

            return { left: snappedLeft, top: snappedTop };
        }

        function showGuide(idx, type, pct, label) {
            const el = document.getElementById('ve-guide-' + idx);
            if (!el) return;
            el.className = 've-guide ' + type + ' active';
            if (type === 'horizontal') el.style.top = pct + '%';
            else el.style.left = pct + '%';
            el.querySelector('.ve-guide-label').textContent = label;
        }

        function hideAllGuides() {
            for (let i = 0; i < 10; i++) {
                const el = document.getElementById('ve-guide-' + i);
                if (el) el.classList.remove('active');
            }
        }

        // ---- MOBILE CANVAS (Absolute Position Layout) ----
        function renderMobileCanvas(ws) {
            const images = data.site.home_images || [];

            const canvasWrap = document.createElement('div');
            canvasWrap.className = 've-canvas-wrap';
            canvasWrap.style.display = 'flex'; canvasWrap.style.justifyContent = 'center'; canvasWrap.style.alignItems = 'flex-start'; canvasWrap.style.padding = '20px';
            const canvas = document.createElement('div');
            canvas.className = 've-canvas mobile-mode';
            canvas.id = 've-mobile-canvas';
            canvasWrap.appendChild(canvas);
            ws.appendChild(canvasWrap);

            // Alignment guides (max 12)
            for (let g = 0; g < 12; g++) {
                const guide = document.createElement('div');
                guide.className = 've-mobile-guide ' + (g < 6 ? 'horizontal' : 'vertical');
                guide.id = 've-mobile-guide-' + g;
                guide.innerHTML = '<span class="ve-mobile-guide-label"></span>';
                canvas.appendChild(guide);
            }

            // Render mobile cards with absolute positioning
            images.forEach((item, i) => {
                if (i >= 5) return;
                const m = getMobile(item, i);
                const src = getImgSrc(item);
                const caption = (typeof item === 'object' && item.caption) || '';

                const card = document.createElement('div');
                card.className = 've-mobile-card' + (i === veSelected ? ' selected' : '');
                card.dataset.col = m.col;
                card.dataset.idx = i;
                card.style.width = m.width + '%';
                card.style.top = m.top + '%';
                card.style.left = m.left + '%';

                card.innerHTML = `
                    <span class="ve-mobile-label">#${i + 1}</span>
                    ${src ? `<img src="${src}" draggable="false">` : '<div style="height:60px;background:#ddd;display:flex;align-items:center;justify-content:center;color:#999;font-size:10px;">NO IMG</div>'}
                    ${caption ? `<div class="ve-mobile-caption">${caption}</div>` : ''}
                    <div class="ve-mobile-resize"></div>
                `;
                canvas.appendChild(card);

                // Click to select + drag to move
                card.addEventListener('mousedown', (e) => {
                    if (e.target.classList.contains('ve-mobile-resize')) return;
                    veSelected = i;
                    document.querySelectorAll('.ve-mobile-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    document.querySelectorAll('.ve-strip-item').forEach((s, si) => s.classList.toggle('selected', si === i));
                    updateMobileProps();
                    startMobileDrag(e, card, i, canvas);
                });

                // Width resize handle
                card.querySelector('.ve-mobile-resize').addEventListener('mousedown', (e) => {
                    e.stopPropagation(); e.preventDefault();
                    veSelected = i;
                    const canvasRect = canvas.getBoundingClientRect();
                    const startX = e.clientX;
                    const startW = m.width;
                    function onMove(ev) {
                        const dx = ((ev.clientX - startX) / canvasRect.width) * 100;
                        let newW = Math.max(15, Math.min(85, startW + dx));
                        newW = Math.round(newW);
                        card.style.width = newW + '%';
                        ensureObj(i).mobile_width = newW;
                        updateMobileProps();
                        // Show alignment guides during resize
                        const curLeft = parseFloat(card.style.left);
                        applyMobileSnapGuides(curLeft, parseFloat(card.style.top), newW, i, canvas, false);
                    }
                    function onUp() {
                        hideMobileGuides();
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    }
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            });

            // Props panel
            const props = document.createElement('div');
            props.className = 've-props';
            props.id = 've-mobile-props';
            ws.appendChild(props);
            updateMobileProps();
        }

        // ---- MOBILE DRAG TO MOVE ----
        function startMobileDrag(e, card, idx, canvas) {
            e.preventDefault();
            card.classList.add('dragging');
            const rect = canvas.getBoundingClientRect();
            const startX = e.clientX, startY = e.clientY;
            const startLeft = parseFloat(card.style.left) || 0;
            const startTop = parseFloat(card.style.top) || 0;
            const cardW = parseFloat(card.style.width) || 50;

            function onMove(ev) {
                const dx = ((ev.clientX - startX) / rect.width) * 100;
                const dy = ((ev.clientY - startY) / rect.height) * 100;
                let newLeft = Math.max(0, Math.min(100 - cardW, startLeft + dx));
                let newTop = Math.max(0, Math.min(90, startTop + dy));

                // Snap to alignment guides (unless Shift)
                if (!ev.shiftKey) {
                    const snapped = applyMobileSnapGuides(newLeft, newTop, cardW, idx, canvas, true);
                    newLeft = snapped.left;
                    newTop = snapped.top;
                } else {
                    hideMobileGuides();
                }

                card.style.left = newLeft + '%';
                card.style.top = newTop + '%';
                ensureObj(idx).mobile_left = Math.round(newLeft);
                ensureObj(idx).mobile_top = Math.round(newTop);
                // Auto-detect col based on position
                const col = newLeft + cardW / 2 > 50 ? 'right' : 'left';
                ensureObj(idx).mobile_col = col;
                card.dataset.col = col;
                updateMobileProps();
            }
            function onUp() {
                card.classList.remove('dragging');
                hideMobileGuides();
                document.removeEventListener('mousemove', onMove);
                document.removeEventListener('mouseup', onUp);
            }
            document.addEventListener('mousemove', onMove);
            document.addEventListener('mouseup', onUp);
        }

        // ---- MOBILE ALIGNMENT SNAP GUIDES ----
        function applyMobileSnapGuides(left, top, width, idx, canvas, snap) {
            let snappedLeft = left, snappedTop = top;
            let guideIdx = 0;
            hideMobileGuides();

            // Current image edges
            const right = left + width;

            // Dynamic: snap to other images
            document.querySelectorAll('.ve-mobile-card').forEach(other => {
                const oIdx = parseInt(other.dataset.idx);
                if (oIdx === idx || guideIdx >= 12) return;
                const oLeft = parseFloat(other.style.left) || 0;
                const oTop = parseFloat(other.style.top) || 0;
                const oWidth = parseFloat(other.style.width) || 50;
                const oRight = oLeft + oWidth;

                // Vertical guides: Left edge alignment
                if (Math.abs(left - oLeft) < MOBILE_SNAP_THRESHOLD) {
                    if (snap) snappedLeft = oLeft;
                    showMobileGuide(guideIdx++, 'vertical', oLeft, '‚Üê align #' + (oIdx + 1));
                }
                // Right edge alignment
                if (Math.abs(right - oRight) < MOBILE_SNAP_THRESHOLD) {
                    if (snap) snappedLeft = oRight - width;
                    showMobileGuide(guideIdx++, 'vertical', oRight, '‚Üí align #' + (oIdx + 1));
                }
                // Left to Right alignment (current left = other right)
                if (Math.abs(left - oRight) < MOBILE_SNAP_THRESHOLD) {
                    if (snap) snappedLeft = oRight;
                    showMobileGuide(guideIdx++, 'vertical', oRight, '|‚Üê #' + (oIdx + 1));
                }
                // Right to Left alignment (current right = other left)
                if (Math.abs(right - oLeft) < MOBILE_SNAP_THRESHOLD) {
                    if (snap) snappedLeft = oLeft - width;
                    showMobileGuide(guideIdx++, 'vertical', oLeft, '‚Üí| #' + (oIdx + 1));
                }
                // Horizontal guides: Top alignment
                if (Math.abs(top - oTop) < MOBILE_SNAP_THRESHOLD) {
                    if (snap) snappedTop = oTop;
                    showMobileGuide(guideIdx++, 'horizontal', oTop, '‚Üë align #' + (oIdx + 1));
                }
            });

            // Canvas edge snaps (0%, 50%, 100%)
            [0, 50].forEach(line => {
                if (Math.abs(left - line) < MOBILE_SNAP_THRESHOLD) {
                    if (snap) snappedLeft = line;
                    showMobileGuide(guideIdx++, 'vertical', line, line + '%');
                }
                if (Math.abs(right - line) < MOBILE_SNAP_THRESHOLD && line > 0) {
                    if (snap) snappedLeft = line - width;
                    showMobileGuide(guideIdx++, 'vertical', line, line + '%');
                }
            });

            return { left: snappedLeft, top: snappedTop };
        }

        function showMobileGuide(idx, type, pct, label) {
            const el = document.getElementById('ve-mobile-guide-' + idx);
            if (!el) return;
            el.className = 've-mobile-guide ' + type + ' active';
            if (type === 'horizontal') el.style.top = pct + '%';
            else el.style.left = pct + '%';
            el.querySelector('.ve-mobile-guide-label').textContent = label;
        }

        function hideMobileGuides() {
            for (let i = 0; i < 12; i++) {
                const el = document.getElementById('ve-mobile-guide-' + i);
                if (el) el.classList.remove('active');
            }
        }

        function updateMobileProps() {
            const props = document.getElementById('ve-mobile-props');
            if (!props) return;
            const images = data.site.home_images || [];
            const i = veSelected;
            if (i >= images.length) return;
            const item = images[i];
            const m = getMobile(item, i);
            const caption = (typeof item === 'object' && item.caption) || '';

            props.innerHTML = `
                <div class="ve-props-title">Image #${i + 1} Â±ûÊÄß</div>
                <div class="ve-props-card" style="border-color:#b8dab8;">
                    <div style="font-size:11px; font-weight:700; color:#2e7d32; margin-bottom:8px;">üì± MOBILE</div>
                    <div style="margin-bottom:8px;">
                        <label>‚Üï ‰∏ä Top %</label>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <input type="range" min="0" max="90" value="${m.top}" oninput="this.nextElementSibling.value=this.value; veSetMobile(${i},'mobile_top',parseInt(this.value))" style="flex:1; accent-color:#2e7d32;">
                            <input type="number" min="0" max="90" value="${m.top}" oninput="this.previousElementSibling.value=this.value; veSetMobile(${i},'mobile_top',parseInt(this.value))" style="width:48px; text-align:center; padding:4px; border:1px solid #b8dab8; border-radius:4px; font-size:12px;">
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <label>‚Üî Â∑¶ Left %</label>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <input type="range" min="0" max="85" value="${m.left}" oninput="this.nextElementSibling.value=this.value; veSetMobile(${i},'mobile_left',parseInt(this.value))" style="flex:1; accent-color:#2e7d32;">
                            <input type="number" min="0" max="85" value="${m.left}" oninput="this.previousElementSibling.value=this.value; veSetMobile(${i},'mobile_left',parseInt(this.value))" style="width:48px; text-align:center; padding:4px; border:1px solid #b8dab8; border-radius:4px; font-size:12px;">
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <label>‚¨å ÂÆΩÂ∫¶ Width %</label>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <input type="range" min="15" max="85" value="${m.width}" oninput="this.nextElementSibling.value=this.value; veSetMobile(${i},'mobile_width',parseInt(this.value))" style="flex:1; accent-color:#2e7d32;">
                            <input type="number" min="15" max="85" value="${m.width}" oninput="this.previousElementSibling.value=this.value; veSetMobile(${i},'mobile_width',parseInt(this.value))" style="width:48px; text-align:center; padding:4px; border:1px solid #b8dab8; border-radius:4px; font-size:12px;">
                        </div>
                    </div>
                    <div style="margin-bottom:8px;">
                        <label>ÂØπÈΩê Align</label>
                        <select onchange="veSetMobile(${i},'mobile_col',this.value)" style="background:#fff;">
                            <option value="left" ${m.col === 'left' ? 'selected' : ''}>‚Üê Â∑¶ÂØπÈΩê Caption</option>
                            <option value="right" ${m.col === 'right' ? 'selected' : ''}>‚Üí Âè≥ÂØπÈΩê Caption</option>
                        </select>
                    </div>
                    <div class="ve-prop-hint">ÊãñÊãΩÂõæÁâáÁßªÂä®‰ΩçÁΩÆ ¬∑ ÊãñÊãΩÊâãÊüÑË∞ÉÂÆΩÂ∫¶ ¬∑ Shift Á¶ÅÁî®Âê∏ÈôÑ</div>
                </div>
                <div class="ve-props-card">
                    <label>üìç Caption</label>
                    <input type="text" placeholder="‰æã: Kyoto, Japan" value="${caption}" oninput="veSetCaption(${i}, this.value)">
                </div>
                <div class="ve-props-card">
                    <label>‰∏ä‰º†/Êõ¥Êç¢</label>
                    <button class="btn" style="font-size:10px; padding:6px; width:100%; border-radius:4px;" onclick="document.getElementById('ve-upload-m-${i}').click()">
                        ${(typeof item === 'object' && item.src) || typeof item === 'string' ? 'Êõ¥Êç¢ÂõæÁâá' : '‰∏ä‰º†ÂõæÁâá'}
                    </button>
                    <input type="file" id="ve-upload-m-${i}" style="display:none" onchange="uploadFile(this, (path) => { ensureObj(${i}).src = path; renderHomeImagesEditor(); })">
                </div>
            `;
        }

        function veSetMobile(i, key, val) {
            const obj = ensureObj(i);
            obj[key] = val;
            // Refresh mobile canvas card
            const card = document.querySelector(`.ve-mobile-card[data-idx="${i}"]`);
            if (card) {
                if (key === 'mobile_col') card.dataset.col = val;
                if (key === 'mobile_width') card.style.width = val + '%';
                if (key === 'mobile_top') card.style.top = val + '%';
                if (key === 'mobile_left') card.style.left = val + '%';
            }
        }

        // ---- IMAGE STRIP ----
        function renderImageStrip(root) {
            const images = data.site.home_images || [];
            const strip = document.createElement('div');
            strip.className = 've-strip';
            strip.id = 've-image-strip';

            images.forEach((item, i) => {
                if (i >= 5) return;
                const src = getImgSrc(item);
                const el = document.createElement('div');
                el.className = 've-strip-item' + (i === veSelected ? ' selected' : '');
                el.innerHTML = `
                    ${src ? `<img src="${src}" draggable="false">` : '<div style="height:56px;background:#eee;display:flex;align-items:center;justify-content:center;font-size:9px;color:#ccc;">EMPTY</div>'}
                    <span>#${i + 1}</span>
                `;
                el.addEventListener('click', () => {
                    veSelected = i;
                    document.querySelectorAll('.ve-strip-item').forEach((s, si) => s.classList.toggle('selected', si === i));
                    // Also select on canvas
                    if (veMode === 'desktop') {
                        document.querySelectorAll('.ve-img').forEach(v => v.classList.toggle('selected', parseInt(v.dataset.idx) === i));
                        updateDesktopProps();
                    } else {
                        document.querySelectorAll('.ve-mobile-card').forEach(c => c.classList.toggle('selected', parseInt(c.dataset.idx) === i));
                        updateMobileProps();
                    }
                });
                strip.appendChild(el);
            });

            // SortableJS for reordering
            root.appendChild(strip);
            if (typeof Sortable !== 'undefined') {
                new Sortable(strip, {
                    animation: 150,
                    onEnd: (ev) => {
                        const arr = data.site.home_images;
                        const moved = arr.splice(ev.oldIndex, 1)[0];
                        arr.splice(ev.newIndex, 0, moved);
                        veSelected = ev.newIndex;
                        renderHomeImagesEditor();
                    }
                });
            }
        }

        // Legacy compat aliases
        function moveHomeImage(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= data.site.home_images.length || newIndex >= 5) return;
            const temp = data.site.home_images[index];
            data.site.home_images[index] = data.site.home_images[newIndex];
            data.site.home_images[newIndex] = temp;
            renderHomeImagesEditor();
        }
        function updateHomeImage(index, path) {
            ensureObj(index).src = path;
            renderHomeImagesEditor();
        }
        function updateHomeStyle(index, key, val) {
            ensureObj(index).style[key] = val;
        }
        function updateHomeMobile(index, key, val) {
            ensureObj(index)[key] = val;
        }

        // --- CONTACT LIST ---

        function renderContactList() {
            const container = document.getElementById('contact-list-container');
            container.innerHTML = '';
            data.site.contact_items.forEach((item, i) => {
                const div = document.createElement('div');
                div.className = 'contact-list-item';
                div.style.cssText = 'background:#fff;padding:16px 20px;border:1px solid #eee;display:flex;gap:16px;align-items:center;border-radius:4px;margin-bottom:4px;transition:all 0.2s;';
                div.dataset.contactIdx = i;
                div.innerHTML = `
                    <div style="cursor:grab;color:#ccc;font-size:16px;padding:0 4px;" class="drag-handle" title="ÊãñÊãΩÊéíÂ∫è">‚†ø</div>
                    <div style="flex:1;display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
                        <div><label style="font-size:9px;color:#999;text-transform:uppercase;">Label</label><input type="text" value="${item.label}" oninput="updateContactItem(${i}, 'label', this.value)" style="width:100%;padding:6px 0;border:none;border-bottom:1px solid #eee;font-size:13px;"></div>
                        <div><label style="font-size:9px;color:#999;text-transform:uppercase;">Value</label><input type="text" value="${item.value}" oninput="updateContactItem(${i}, 'value', this.value)" style="width:100%;padding:6px 0;border:none;border-bottom:1px solid #eee;font-size:13px;"></div>
                        <div><label style="font-size:9px;color:#999;text-transform:uppercase;">Link</label><input type="text" placeholder="Optional" value="${item.link || ''}" oninput="updateContactItem(${i}, 'link', this.value)" style="width:100%;padding:6px 0;border:none;border-bottom:1px solid #eee;font-size:13px;"></div>
                    </div>
                    <button class="btn btn-danger" style="padding:6px 10px;font-size:11px;font-weight:700;border-radius:3px;" onclick="removeContactItem(${i})" title="Delete">‚úï</button>
                `;
                container.appendChild(div);
            });

            // SortableJS for contact items
            if (typeof Sortable !== 'undefined') {
                new Sortable(container, {
                    animation: 200,
                    handle: '.drag-handle',
                    onEnd: (evt) => {
                        const movedItem = data.site.contact_items.splice(evt.oldIndex, 1)[0];
                        data.site.contact_items.splice(evt.newIndex, 0, movedItem);
                        renderContactList();
                    }
                });
            }
        }
        function addContactItem() {
            if (!data.site.contact_items) data.site.contact_items = [];
            data.site.contact_items.push({ label: "New", value: "", link: "" });
            renderContactList();
        }
        function removeContactItem(index) {
            data.site.contact_items.splice(index, 1);
            renderContactList();
        }
        function moveContactItem(index, dir) {
            const target = index + dir;
            if (target >= 0 && target < data.site.contact_items.length) {
                [data.site.contact_items[index], data.site.contact_items[target]] = [data.site.contact_items[target], data.site.contact_items[index]];
                renderContactList();
            }
        }
        function updateContactItem(index, key, val) { data.site.contact_items[index][key] = val; }

        // --- PROJECTS ---

        function renderProjects() {
            const container = document.getElementById('projects-list');
            container.innerHTML = '';

            // Performance: Use DocumentFragment for batch DOM operations
            const fragment = document.createDocumentFragment();

            data.projects.forEach((proj, i) => {
                const layout = proj.layout || {};
                const galleryLayout = proj.gallery_layout || {};

                // COLLAPSE LOGIC: Default to collapsed (true) if undefined
                const isCollapsed = proj._collapsed === undefined ? true : proj._collapsed;
                const displayStyle = isCollapsed ? 'none' : 'block';
                const toggleIcon = isCollapsed ? '+' : '‚àí';
                const iconColor = isCollapsed ? '#666' : '#000';

                const div = document.createElement('div');
                div.className = 'project-item';
                div.dataset.projIndex = i;
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #000; padding-bottom:15px;">
                        <div style="display:flex; align-items:center; gap:12px; flex-grow:1;">
                            <div style="cursor:grab;color:#ccc;font-size:18px;padding:0 4px;" class="proj-drag-handle" title="ÊãñÊãΩÊéíÂ∫è">‚†ø</div>
                            <div style="display:flex; align-items:center; gap:12px; cursor:pointer; flex-grow:1;" onclick="toggleProject(${i})" title="Click to Expand/Collapse">
                                <button class="btn" style="background:transparent; color:${iconColor}; padding:0; font-size:24px; font-family:monospace; width:24px; height:24px; display:flex; align-items:center; justify-content:center; border:none;">${toggleIcon}</button>
                                <img src="${proj.image}" style="height:32px; width:32px; object-fit:cover; border-radius:4px; background:#f0f0f0;">
                                <strong style="font-family:var(--font-serif); font-size:20px;">${proj.title || 'Untitled'}</strong>
                                <span class="photo-count-badge">${(proj.gallery || []).length} photos</span>
                            </div>
                        </div>
                        
                        <button class="btn btn-danger" style="padding:6px 12px; font-size:11px; font-weight:700; border-radius:3px;" onclick="deleteProject(${i})" title="Delete Project">‚úï</button>
                    </div>

                    <div id="proj-content-${i}" style="display:${displayStyle};">
                        <div class="row-inputs" style="margin-top:15px;">
                            <div><label>Title</label><input type="text" value="${proj.title}" oninput="updateProject(${i}, 'title', this.value)"></div>
                            <div><label>Year / Meta</label><input type="text" value="${proj.year}" oninput="updateProject(${i}, 'year', this.value)"></div>
                        </div>
                        
                        <details style="margin-top:20px;">
                            <summary style="font-size:11px; font-weight:700; color:#999; cursor:pointer; list-style:none; margin-bottom:10px; user-select:none;">PROJECT LAYOUT ‚ñº</summary>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                                <div style="background:#fff; padding:15px; border:1px solid #eee;">
                                    <label style="color:#999; font-size:10px;">Layout Control (Info Text)</label>
                                    <div class="row-inputs" style="gap:8px; margin-top:10px;">
                                        <div><label style="font-size:9px; color:#999;">Top (px)</label><input type="number" placeholder="Def: 40" value="${layout.top || ''}" oninput="updateProjectLayout(${i}, 'top', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                        <div><label style="font-size:9px; color:#999;">Left (px)</label><input type="number" placeholder="Def: 0" value="${layout.left || ''}" oninput="updateProjectLayout(${i}, 'left', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                        <div><label style="font-size:9px; color:#999;">Width (%)</label><input type="number" placeholder="Def: 300px" value="${layout.width || ''}" oninput="updateProjectLayout(${i}, 'width', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                    </div>
                                </div>
                                <div style="background:#fff; padding:15px; border:1px solid #eee;">
                                    <label style="color:#999; font-size:10px;">Layout Control (Gallery Images)</label>
                                    <div class="row-inputs" style="gap:8px; margin-top:10px;">
                                        <div><label style="font-size:9px; color:#999;">Top %</label><input type="number" placeholder="Def: 0" value="${galleryLayout.top || ''}" oninput="updateProjectGalleryLayout(${i}, 'top', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                        <div><label style="font-size:9px; color:#999;">Left %</label><input type="number" placeholder="Def: 0" value="${galleryLayout.left || ''}" oninput="updateProjectGalleryLayout(${i}, 'left', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                        <div><label style="font-size:9px; color:#999;">Width %</label><input type="number" placeholder="Def: 100" value="${galleryLayout.width || ''}" oninput="updateProjectGalleryLayout(${i}, 'width', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                    </div>
                                </div>
                            </div>
                        </details>

                        <div style="margin-top:15px;"><label>Description</label><textarea style="min-height:80px;" oninput="updateProject(${i}, 'description', this.value)">${proj.description || ''}</textarea></div>
                        <div style="margin-top:15px;"><label>Cover Image (List View)</label>
                            <div style="display:flex; gap:10px; align-items:center;">
                                <img src="${proj.image}" style="height:40px; border-radius:4px;">
                                <input type="file" onchange="uploadFile(this, (path) => updateProject(${i}, 'image', path))">
                            </div>
                        </div>

                        <div style="margin-top:15px;">
                            <div class="gallery-toolbar">
                                <label>Gallery Images</label>
                                <div style="display:flex;gap:8px;align-items:center;">
                                    <span style="font-size:11px;color:#999;">${(proj.gallery || []).length} photos</span>
                                    <button class="btn" style="font-size:9px;padding:4px 10px;" onclick="document.getElementById('gallery-upload-${i}').click()">+ ADD</button>
                                </div>
                            </div>
                            <div class="gallery-grid" id="gallery-grid-${i}"></div>
                            <input type="file" id="gallery-upload-${i}" style="display:none" multiple onchange="uploadFilesBatch(this, (paths) => addGalleryImagesBatch(${i}, paths))">
                        </div>
                    </div>
                `;
                fragment.appendChild(div);

                // Render Gallery Grid (Optimized with lazy loading)
                const grid = div.querySelector(`#gallery-grid-${i}`);
                const galleryFragment = document.createDocumentFragment();

                (proj.gallery || []).forEach((imgItem, imgIndex) => {
                    // Normalize
                    const src = typeof imgItem === 'string' ? imgItem : imgItem.src;
                    const caption = (typeof imgItem === 'object' && imgItem.caption) ? imgItem.caption : "";

                    const thumb = document.createElement('div');
                    thumb.className = 'img-thumb-container';
                    thumb.style.height = 'auto';
                    thumb.dataset.projIndex = i;
                    thumb.dataset.imgIndex = imgIndex;
                    const isCover = src === proj.image;
                    thumb.innerHTML = `
                        <img src="${src}" draggable="false" loading="lazy">
                        <input type="text" class="image-caption-input" placeholder="ËæìÂÖ•ÁÖßÁâáÊèèËø∞..." value="${caption}">
                        <button class="img-set-cover" title="ËÆæ‰∏∫Â∞ÅÈù¢">‚òÜ COVER</button>
                        <button class="img-remove" data-proj="${i}" data-img="${imgIndex}">√ó</button>
                    `;
                    if (isCover) thumb.classList.add('is-cover');

                    // Set as cover button
                    thumb.querySelector('.img-set-cover').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const liveIndex = parseInt(thumb.dataset.imgIndex);
                        setAsCoverByIndex(i, liveIndex);
                    });

                    // Remove button click ‚Äî use live dataset index (survives drag reorder)
                    thumb.querySelector('.img-remove').addEventListener('click', () => {
                        const liveIndex = parseInt(thumb.dataset.imgIndex);
                        removeGalleryImage(i, liveIndex);
                    });

                    // Attach debounced caption handler
                    const captionInput = thumb.querySelector('.image-caption-input');
                    if (captionInput) {
                        captionInput.addEventListener('input', debounce((e) => {
                            // Use live index from dataset (updated by SortableJS onEnd)
                            const liveIndex = parseInt(thumb.dataset.imgIndex);
                            updateGalleryCaption(i, liveIndex, e.target.value);
                        }, 500));
                    }

                    galleryFragment.appendChild(thumb);
                });

                // Batch insert all thumbnails
                grid.appendChild(galleryFragment);

                // Initialize SortableJS on this gallery grid
                initSortable(grid, i);

                // Add drag hint
                const hint = document.createElement('div');
                hint.className = 'drag-hint';
                hint.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M5 9l4-4 4 4"/><path d="M11 5v14"/><path d="M19 15l-4 4-4-4"/><path d="M13 19V5"/></svg> ÊãñÊãΩÁº©Áï•ÂõæÂèØË∞ÉÊï¥ÁÖßÁâáÈ°∫Â∫èÔºàÊîØÊåÅËß¶Â±èÔºâ`;
                grid.parentNode.insertBefore(hint, grid.nextSibling);
            });

            // Performance: Batch append all projects at once
            container.appendChild(fragment);

            // SortableJS for project-level reordering
            if (typeof Sortable !== 'undefined') {
                new Sortable(container, {
                    animation: 200,
                    handle: '.proj-drag-handle',
                    filter: '.image-caption-input, input, textarea, select, button',
                    preventOnFilter: false,
                    onEnd: (evt) => {
                        const movedProj = data.projects.splice(evt.oldIndex, 1)[0];
                        data.projects.splice(evt.newIndex, 0, movedProj);
                        renderProjects();
                    }
                });
            }
        }

        function updateProject(index, key, val) {
            data.projects[index][key] = val;
            if (key === 'title' || key === 'image') renderProjects();
        }
        function updateProjectLayout(index, key, val) {
            if (!data.projects[index].layout) data.projects[index].layout = {};
            data.projects[index].layout[key] = val;
        }
        function updateProjectGalleryLayout(index, key, val) {
            if (!data.projects[index].gallery_layout) data.projects[index].gallery_layout = {};
            data.projects[index].gallery_layout[key] = val;
        }

        function addGalleryImage(idx, path) {
            if (!data.projects[idx].gallery) data.projects[idx].gallery = [];
            data.projects[idx].gallery.push(path);
            renderProjects();
        }

        function addGalleryImagesBatch(idx, paths) {
            if (!data.projects[idx].gallery) data.projects[idx].gallery = [];
            paths.forEach(p => data.projects[idx].gallery.push(p));
            renderProjects();
        }

        // SortableJS instances registry (for cleanup on re-render)
        const sortableInstances = {};

        function initSortable(gridEl, projIndex) {
            // Destroy previous instance if re-rendering
            if (sortableInstances[projIndex]) {
                sortableInstances[projIndex].destroy();
            }

            sortableInstances[projIndex] = new Sortable(gridEl, {
                animation: 200,
                easing: 'cubic-bezier(0.25, 1, 0.5, 1)',
                ghostClass: 'sortable-ghost',
                dragClass: 'sortable-drag',
                chosenClass: 'sortable-chosen',
                // Exclude remove button and caption input from drag handle
                filter: '.img-remove, .image-caption-input',
                preventOnFilter: false,
                // Touch delay to avoid conflicts with caption input focus
                delay: 150,
                delayOnTouchOnly: true,
                touchStartThreshold: 3,
                // Use swap-style movement for grid layout
                swapThreshold: 0.65,
                // Callback when drag is complete
                onEnd: function (evt) {
                    const fromIndex = evt.oldIndex;
                    const toIndex = evt.newIndex;
                    if (fromIndex === toIndex) return;

                    const gallery = data.projects[projIndex].gallery;
                    if (!gallery) return;

                    // SortableJS already moved the DOM element. Sync data model.
                    const [movedItem] = gallery.splice(fromIndex, 1);
                    gallery.splice(toIndex, 0, movedItem);

                    // Update all dataset indices for caption/remove handlers
                    const allItems = Array.from(gridEl.querySelectorAll('.img-thumb-container'));
                    allItems.forEach((item, newIndex) => {
                        item.dataset.imgIndex = newIndex;
                    });

                    console.log(`[Gallery] Moved image from position ${fromIndex + 1} to ${toIndex + 1}`);
                }
            });
        }

        // New Batch Upload Helper
        async function uploadFilesBatch(input, callback) {
            if (!input.files || input.files.length === 0) return;

            const total = input.files.length;
            const progressEl = document.getElementById('upload-progress');
            const barEl = document.getElementById('upload-progress-bar');
            if (progressEl) progressEl.classList.add('active');

            const paths = [];
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const formData = new FormData();
                formData.append('file', file);

                const pct = Math.round(((i) / total) * 100);
                if (barEl) barEl.style.width = pct + '%';

                try {
                    const res = await fetch('/api/upload', { method: 'POST', body: formData });
                    if (res.ok) {
                        const json = await res.json();
                        paths.push(json.filepath);
                    }
                } catch (e) {
                    console.error("Upload failed for file " + i, e);
                }
            }

            if (barEl) barEl.style.width = '100%';
            setTimeout(() => {
                if (progressEl) progressEl.classList.remove('active');
                if (barEl) barEl.style.width = '0%';
            }, 500);

            if (paths.length > 0) {
                showToast(`‚úì ${paths.length}/${total} Âº†ÂõæÁâá‰∏ä‰º†ÊàêÂäü`, 'success');
                callback(paths);
            }
            input.value = '';
        }

        function updateGalleryCaption(projIndex, imgIndex, val) {
            let item = data.projects[projIndex].gallery[imgIndex];
            if (typeof item === 'string') {
                data.projects[projIndex].gallery[imgIndex] = { src: item, caption: val };
            } else {
                item.caption = val;
            }
        }

        function removeGalleryImage(idx, imgIdx) {
            data.projects[idx].gallery.splice(imgIdx, 1);
            renderProjects();
        }
        function addNewProject() {
            data.projects.unshift({ id: "new-" + Date.now(), title: "NEW PROJECT", year: "2026", description: "...", image: "images/placeholder.jpg", gallery: [] });
            renderProjects();
        }
        // Delete with double-click confirmation (avoids browser confirm() blocking)
        let deleteConfirmState = { index: -1, timeout: null };
        function deleteProject(index) {
            if (deleteConfirmState.index === index) {
                // Second click - actually delete
                clearTimeout(deleteConfirmState.timeout);
                data.projects.splice(index, 1);
                deleteConfirmState = { index: -1, timeout: null };
                renderProjects();
            } else {
                // First click - show warning
                clearTimeout(deleteConfirmState.timeout);
                deleteConfirmState.index = index;

                // Visual feedback
                const btn = event.target;
                btn.textContent = 'Á°ÆÂÆö?';
                btn.style.width = '50px';

                // Reset after 2 seconds
                deleteConfirmState.timeout = setTimeout(() => {
                    deleteConfirmState = { index: -1, timeout: null };
                    btn.textContent = 'X';
                    btn.style.width = '';
                }, 2000);
            }
        }
        function toggleProject(index) {
            // Initialize if undefined (default logic handles this, but good to be explicit)
            if (data.projects[index]._collapsed === undefined) {
                data.projects[index]._collapsed = true;
            }
            // Toggle
            data.projects[index]._collapsed = !data.projects[index]._collapsed;
            renderProjects();
        }

        function moveProject(index, dir) {
            const target = index + dir;
            if (target >= 0 && target < data.projects.length) {
                [data.projects[index], data.projects[target]] = [data.projects[target], data.projects[index]];
                renderProjects();
            }
        }

        // --- UTILS ---

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');

            // Sync Sidebar Button State
            const btn = document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`);
            if (btn) btn.classList.add('active');

            // Update Page Title with translation
            const titles = { 'home': 'page.index', 'portfolios': 'page.collections', 'info': 'page.biography', 'contact': 'page.dialogue' };
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) pageTitle.innerText = t(titles[tabId] || 'page.index');
        }


        function updateContactLayout(side, key, val) {
            const prop = side === 'info' ? 'contact_info_layout' : 'contact_gallery_layout';
            if (!data.site[prop]) data.site[prop] = {};
            data.site[prop][key] = val;
        }

        // Toggle between random and fixed contact images
        function toggleContactImageMode(isRandom) {
            if (!data.site) data.site = {};
            data.site.contact_random_mode = isRandom;

            // Update UI
            const toggle = document.getElementById('contact-random-toggle');
            const label = document.getElementById('contact-mode-label');
            const fixedSection = document.getElementById('contact-fixed-section');

            if (toggle) toggle.checked = isRandom;
            if (label) label.textContent = isRandom ? 'üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè (Â∑≤ÂºÄÂêØ)' : 'üñºÔ∏è Âõ∫ÂÆöÂõæÁâáÊ®°Âºè';
            if (fixedSection) fixedSection.style.opacity = isRandom ? '0.4' : '1';

            // If switching to random, clear fixed images
            if (isRandom) {
                data.site.contact_fixed_images = [];
                renderContactImagesEditor();
            }
        }

        function renderContactImagesEditor() {
            const container = document.getElementById('contact-images-list');
            container.innerHTML = '';
            if (!data.site.contact_fixed_images) data.site.contact_fixed_images = [];

            // Update toggle state based on current mode
            const isRandom = data.site.contact_random_mode === true ||
                (data.site.contact_fixed_images.filter(s => s).length === 0);
            const toggle = document.getElementById('contact-random-toggle');
            const label = document.getElementById('contact-mode-label');
            const fixedSection = document.getElementById('contact-fixed-section');

            if (toggle) toggle.checked = isRandom;
            if (label) label.textContent = isRandom ? 'üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè (Â∑≤ÂºÄÂêØ)' : 'üñºÔ∏è Âõ∫ÂÆöÂõæÁâáÊ®°Âºè';
            if (fixedSection) fixedSection.style.opacity = isRandom ? '0.4' : '1';

            // Ensure 3 slots
            for (let i = 0; i < 3; i++) {
                const src = data.site.contact_fixed_images[i] || "";
                const div = document.createElement('div');
                div.style.flex = '1';
                div.innerHTML = `
                    <div style="background:#f5f5f5; height:100px; margin-bottom:8px; overflow:hidden; border:1px solid #eee;">
                        <img src="${src}" style="width:100%; height:100%; object-fit:cover; opacity:${src ? 1 : 0.3}">
                    </div>
                    ${src ? `<button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-bottom:4px;" onclick="updateContactImage(${i}, '')">CLEAR</button>` : ''}
                    <button class="btn" style="width:100%; font-size:10px; padding:6px;" onclick="document.getElementById('c-upload-${i}').click()">${src ? 'REPLACE' : 'SELECT'}</button>
                    <input type="file" id="c-upload-${i}" style="display:none" onchange="uploadFile(this, (path) => updateContactImage(${i}, path))">
                 `;
                container.appendChild(div);
            }
        }

        function updateContactImage(index, path) {
            if (!data.site.contact_fixed_images) data.site.contact_fixed_images = [];
            if (path === '') {
                data.site.contact_fixed_images[index] = "";
                // If all empty, maybe clear array? Logic handles empty string as "random" if slots not filled, 
                // but script.js checks if array length > 0.
                // Actually script.js checks: if (siteInfo.contact_fixed_images && ... length > 0)
                // If [ "", "managed", "" ] -> it might show empty, managed, empty.
                // script.js logic: slice(0,3).map. 
                // I should ensure script.js handles empty strings in array by picking random? 
                // Current script.js: `targetImages = siteInfo.contact_fixed_images.slice(0, 3).map...`
                // It doesn't fallback per slot. It falls back if valid images array not found.
                // I will tell user: "Fill all 3 for best results or Clear All to go back to Random".
            } else {
                data.site.contact_fixed_images[index] = path;
            }
            // Remove trailing empty strings to fallback to random if all clear
            if (data.site.contact_fixed_images.every(s => !s)) data.site.contact_fixed_images = [];

            renderContactImagesEditor();
        }

        async function uploadFile(input, callback) {
            if (!input.files || !input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.status === 'success') callback(json.filepath);
                else alert('Upload failed');
            } catch (e) { alert('Error uploading'); }
        }

        // --- Toast Notification System ---
        function showToast(message, type = 'success') {
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container';
                document.body.appendChild(container);
            }
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            const icons = { success: '‚úì', error: '‚úï', info: '‚Ñπ' };
            toast.innerHTML = `<span>${icons[type] || ''}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        async function saveData() {
            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (json.status === 'success') {
                    showToast('‚úì Â∑≤‰øùÂ≠ò Saved!', 'success');
                    clearDirty();
                }
                else showToast('‰øùÂ≠òÂ§±Ë¥•: ' + json.message, 'error');
            } catch (e) { showToast('ËøûÊé•ÈîôËØØ Connection Error', 'error'); }
        }
        // === PHASE 1 ENHANCEMENTS ===

        // --- Dirty State Tracking ---
        let isDirty = false;
        let autoSaveTimer = null;

        function markDirty() {
            if (isDirty) return;
            isDirty = true;
            updateDirtyUI();
            startAutoSaveTimer();
        }

        function clearDirty() {
            isDirty = false;
            updateDirtyUI();
            if (autoSaveTimer) { clearInterval(autoSaveTimer); autoSaveTimer = null; }
            localStorage.removeItem('admin_draft');
            localStorage.removeItem('admin_draft_time');
        }

        function updateDirtyUI() {
            const saveBtn = document.getElementById('btn-save');
            if (!saveBtn) return;
            const dot = saveBtn.querySelector('.unsaved-dot');
            if (isDirty && !dot) {
                const d = document.createElement('span');
                d.className = 'unsaved-dot';
                d.title = 'ÊúâÊú™‰øùÂ≠òÁöÑÊõ¥Êîπ';
                saveBtn.appendChild(d);
            } else if (!isDirty && dot) {
                dot.remove();
            }
        }

        // --- Auto-Save Draft ---
        function startAutoSaveTimer() {
            if (autoSaveTimer) return;
            autoSaveTimer = setInterval(() => {
                if (isDirty && data) {
                    try {
                        localStorage.setItem('admin_draft', JSON.stringify(data));
                        localStorage.setItem('admin_draft_time', new Date().toISOString());
                        console.log('[AutoSave] Draft saved to localStorage');
                    } catch (e) { console.warn('[AutoSave] Failed:', e); }
                }
            }, 60000);
        }

        // --- Set Gallery Image as Cover ---
        function setAsCoverByIndex(projIndex, imgIndex) {
            const gallery = data.projects[projIndex].gallery;
            if (!gallery || !gallery[imgIndex]) return;
            const item = gallery[imgIndex];
            const src = typeof item === 'string' ? item : item.src;
            data.projects[projIndex].image = src;
            markDirty();
            renderProjects();
            showToast('‚úì Â∞ÅÈù¢Â∑≤Êõ¥Êñ∞ Cover Updated', 'success');
        }

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveData();
            }
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'P' || e.key === 'p')) {
                e.preventDefault();
                publishData();
            }
        });

        // --- Unsaved Changes Warning ---
        window.addEventListener('beforeunload', (e) => {
            if (isDirty) { e.preventDefault(); e.returnValue = ''; }
        });

        // --- Auto-detect Input Changes ---
        document.addEventListener('DOMContentLoaded', () => {
            const main = document.querySelector('main');
            if (main) {
                main.addEventListener('input', () => markDirty(), true);
                main.addEventListener('change', () => markDirty(), true);
            }
        });

        // --- Patch Mutation Functions for Dirty Tracking ---
        (function patchDirtyTracking() {
            const fns = ['addNewProject', 'removeGalleryImage', 'addGalleryImagesBatch',
                'addGalleryImage', 'addContactItem', 'removeContactItem',
                'toggleContactImageMode', 'updateContactImage',
                'veSetDesktop', 'veSetMobile', 'veSetCaption'];
            fns.forEach(name => {
                const orig = window[name];
                if (orig) {
                    window[name] = function (...args) { markDirty(); return orig.apply(this, args); };
                }
            });
        })();

    </script>
</body>

</html>