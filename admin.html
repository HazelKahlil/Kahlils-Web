<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN | HAZEL (FIXED)</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <style>
        :root {
            --bg: #1a1a1a;
            --panel: #252525;
            --text: #eee;
            --border: #333;
            --accent: #4a90e2;
            --danger: #e74c3c;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding-bottom: 80px;
        }

        /* Header / Nav */
        header {
            background: #000;
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            /* Ensure proper stacking */
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 18px;
            letter-spacing: 2px;
            font-weight: 400;
        }

        /* Tabs as Navigation */
        .nav-tabs {
            display: flex !important;
            gap: 10px;
            background: #080808;
            /* Slightly lighter than header for contrast */
            padding: 15px 20px;
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            min-height: 40px;
            /* Force height */
            align-items: center;
            position: relative;
            z-index: 5;
        }

        .tab-btn {
            background: #222;
            border: 1px solid #444;
            color: #aaa;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-radius: 4px;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            border-color: #666;
            color: #bbb;
        }

        .tab-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
            font-weight: 600;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 30px 20px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Sections */
        .section-title {
            font-size: 14px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 15px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
            margin-top: 30px;
        }

        .section-title:first-child {
            margin-top: 0;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
            background: var(--panel);
            padding: 20px;
            border-radius: 8px;
        }

        label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            color: #888;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            background: #333;
            border: 1px solid #444;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .row-inputs {
            display: flex;
            gap: 20px;
        }

        .row-inputs>div {
            flex: 1;
        }

        textarea {
            min-height: 150px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        /* Buttons */
        .btn {
            background: #fff;
            color: #000;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-block {
            width: 100%;
            display: block;
            text-align: center;
        }

        /* Project List */
        .project-item {
            background: var(--panel);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            border-left: 4px solid transparent;
        }

        .project-item:hover {
            border-left-color: var(--accent);
        }

        /* Images */
        .img-thumb-container {
            position: relative;
            background: #1a1a1a;
            border-radius: 6px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .img-thumb-container img {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
            opacity: 0.9;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            margin-top: 10px;
            margin-bottom: 15px;
        }

        .img-remove {
            position: absolute;
            top: 4px;
            right: 4px;
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            line-height: 16px;
            z-index: 10;
        }

        .image-caption-input {
            width: 100%;
            background: #111;
            color: #ccc;
            border: 1px solid #333;
            font-size: 9px;
            padding: 4px 6px;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .image-caption-input::placeholder {
            color: #666;
        }

        /* Drag and Drop Styles */
        .img-thumb-container {
            cursor: grab;
            transition: transform 0.2s, opacity 0.2s, box-shadow 0.2s;
        }

        .img-thumb-container:active {
            cursor: grabbing;
        }

        .img-thumb-container.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .img-thumb-container.drag-over {
            box-shadow: 0 0 0 2px var(--accent);
            transform: scale(1.02);
        }

        .drag-hint {
            font-size: 9px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        /* Sticky Footer */
        .sticky-actions {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(26, 26, 26, 0.95);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #333;
            backdrop-filter: blur(10px);
            z-index: 100;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.5);
        }

        /* Login */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: #111;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div style="text-align:center;">
            <h2 style="letter-spacing:2px; margin-bottom:20px;">ACCESS</h2>
            <input type="password" id="password-input" placeholder="Password"
                style="text-align:center; margin-bottom:15px; padding:10px;">
            <br>
            <button class="btn btn-primary" onclick="checkAuth()">ENTER</button>
            <p id="login-error" style="color:red; display:none; margin-top:10px;">Incorrect</p>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="app" style="display:none;">
        <header>
            <h1>HAZEL KAHLIL | CMS</h1>
            <a href="./" target="_blank" style="color:#666; font-size:12px; text-decoration:none;">VIEW LIVE
                SITE ‚Üó</a>
        </header>

        <!-- NAVIGATION -->
        <div class="nav-tabs">
            <button class="tab-btn active" onclick="switchTab('home')">PAGE: HOME</button>
            <button class="tab-btn" onclick="switchTab('portfolios')">PAGE: PORTFOLIOS</button>
            <button class="tab-btn" onclick="switchTab('info')">PAGE: INFO</button>
            <button class="tab-btn" onclick="switchTab('contact')">PAGE: CONTACT</button>
        </div>

        <div class="container">

            <!-- TAB: HOME -->
            <div id="tab-home" class="tab-content active">
                <div class="section-title">Global Settings</div>
                <div class="form-group">
                    <div class="row-inputs">
                        <div>
                            <label>Site Main Title</label>
                            <input type="text" id="site-title" oninput="updateSiteData('title', this.value)">
                        </div>
                        <div>
                            <label>Footer Copyright</label>
                            <input type="text" id="site-copyright" oninput="updateSiteData('copyright', this.value)">
                        </div>
                    </div>

                    <!-- New Header Socials -->
                    <div class="row-inputs" style="margin-top:10px;">
                        <div>
                            <label>Header: Instagram URL</label>
                            <input type="text" id="header-ig"
                                oninput="updateSiteData('header_social_instagram', this.value)">
                        </div>
                    </div>
                    <div class="row-inputs" style="margin-top:10px;">
                        <div>
                            <label>Header: Link URL (Chain)</label>
                            <input type="text" id="header-link"
                                oninput="updateSiteData('header_social_link', this.value)">
                        </div>
                        <div>
                            <label>Header: Email Address</label>
                            <input type="text" id="header-email"
                                oninput="updateSiteData('header_social_email', this.value)">
                        </div>
                    </div>
                </div>

                <div class="section-title">Home Hero Images</div>
                <div class="form-group">
                    <label style="margin-bottom:20px;">Use the inputs below to fine-tune position (Top/Left) and Size
                        (Width)</label>
                    <div id="home-images-list"
                        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:20px;">
                    </div>
                </div>
            </div>

            <!-- TAB: PORTFOLIOS -->
            <div id="tab-portfolios" class="tab-content">
                <button class="btn btn-block"
                    style="margin-bottom:20px; border:1px dashed #666; background:transparent; color:#888;"
                    onclick="addNewProject()">+ NEW PROJECT</button>
                <div id="projects-list"></div>
            </div>

            <!-- TAB: INFO (BIO) -->
            <div id="tab-info" class="tab-content">
                <div class="section-title">Biography Content</div>
                <div class="form-group">
                    <label>Main Text (Paragraphs are preserved)</label>
                    <textarea id="site-bio" oninput="updateSiteData('bio', this.value)"></textarea>
                </div>

                <div class="section-title">Layout Control (Desktop Only)</div>
                <div class="form-group">
                    <div class="row-inputs">
                        <div>
                            <label>Padding Top (px)</label>
                            <input type="number" id="bio-top" placeholder="Default: 40"
                                oninput="updateBioLayout('top', this.value)">
                        </div>
                        <div>
                            <label>Padding Left (px)</label>
                            <input type="number" id="bio-left" placeholder="Default: 60"
                                oninput="updateBioLayout('padding_left', this.value)">
                        </div>
                        <div>
                            <label>Width (%)</label>
                            <input type="number" id="bio-width" placeholder="Default: 60"
                                oninput="updateBioLayout('width', this.value)">
                        </div>
                        <div>
                            <label>Max Width (px)</label>
                            <input type="number" id="bio-max-width" placeholder="Default: 600"
                                oninput="updateBioLayout('max_width', this.value)">
                        </div>
                    </div>
                    <p style="font-size:10px; color:#666; margin-top:10px;">Adjust these values to position the text
                        block exactly where you want it. Clear to reset to defaults.</p>
                </div>
            </div>

            <!-- TAB: CONTACT -->
            <div id="tab-contact" class="tab-content">
                <div class="section-title">Contact Details</div>
                <div class="form-group">
                    <div id="contact-list-container" style="display:flex; flex-direction:column; gap:10px;"></div>
                    <button class="btn" onclick="addContactItem()" style="margin-top:10px;">+ Add Contact Row</button>
                </div>

                <div class="section-title">Layout Control (Desktop Only)</div>
                <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                    <div>
                        <label style="color:#aaa;">Info Side (Left)</label>
                        <div class="row-inputs" style="flex-direction:column; gap:5px;">
                            <div><label style="font-size:9px;">Top px</label><input type="number" id="c-info-top"
                                    placeholder="Def: 40" oninput="updateContactLayout('info', 'top', this.value)"
                                    style="padding:4px; font-size:11px;"></div>
                            <div><label style="font-size:9px;">Left px</label><input type="number" id="c-info-left"
                                    placeholder="Def: 0" oninput="updateContactLayout('info', 'left', this.value)"
                                    style="padding:4px; font-size:11px;"></div>
                            <div><label style="font-size:9px;">Width %</label><input type="number" id="c-info-width"
                                    placeholder="Def: 45" oninput="updateContactLayout('info', 'width', this.value)"
                                    style="padding:4px; font-size:11px;"></div>
                        </div>
                    </div>
                    <div>
                        <label style="color:#aaa;">Gallery Side (Right)</label>
                        <div class="row-inputs" style="flex-direction:column; gap:5px;">
                            <div><label style="font-size:9px;">Top px</label><input type="number" id="c-gal-top"
                                    placeholder="Def: 40" oninput="updateContactLayout('gallery', 'top', this.value)"
                                    style="padding:4px; font-size:11px;"></div>
                            <div><label style="font-size:9px;">Margin Left px</label><input type="number"
                                    id="c-gal-left" placeholder="Def: 0"
                                    oninput="updateContactLayout('gallery', 'left', this.value)"
                                    style="padding:4px; font-size:11px;"></div>
                            <div><label style="font-size:9px;">Width %</label><input type="number" id="c-gal-width"
                                    placeholder="Def: 50" oninput="updateContactLayout('gallery', 'width', this.value)"
                                    style="padding:4px; font-size:11px;"></div>
                        </div>
                    </div>
                </div>

                <div class="section-title">Contact Images (Right Side)</div>
                <div class="form-group">
                    <!-- Mode Toggle -->
                    <div style="margin-bottom:15px; padding:10px; background:#1a1a1a; border-radius:6px;">
                        <label style="display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="contact-random-toggle"
                                onchange="toggleContactImageMode(this.checked)"
                                style="width:18px; height:18px; margin-right:10px; cursor:pointer;">
                            <span id="contact-mode-label" style="font-size:12px;">üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè</span>
                        </label>
                        <div id="contact-mode-hint" style="font-size:9px; color:#888; margin-top:5px;">
                            ÂºÄÂêØÂêéÊØèÊ¨°Âà∑Êñ∞È°µÈù¢ÊòæÁ§∫ÈöèÊú∫ÂõæÁâáÔºõÂÖ≥Èó≠Âêé‰ΩøÁî®‰∏ãÊñπÊåáÂÆöÁöÑÂõ∫ÂÆöÂõæÁâá
                        </div>
                    </div>

                    <!-- Fixed Images Section (shown when random is off) -->
                    <div id="contact-fixed-section">
                        <label style="margin-bottom:10px; font-size:10px; color:#888;">Âõ∫ÂÆöÂõæÁâáËÆæÁΩÆÔºà‰ªÖÂú®ÂÖ≥Èó≠ÈöèÊú∫Ê®°ÂºèÊó∂ÁîüÊïàÔºâ</label>
                        <div id="contact-images-list" style="display:flex; gap:10px;"></div>
                    </div>
                </div>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="sticky-actions">
            <div style="font-size:10px; color:#666;">UNSAVED CHANGES ARE LOCAL</div>
            <button class="btn btn-primary" onclick="saveData()">SAVE ALL CHANGES</button>
        </div>
    </div>

    <script>
        let data = { site: {}, projects: [] };

        // Performance: Debounce for input handlers
        function debounce(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function checkAuth() {
            if (document.getElementById('password-input').value === 'hazel2026') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                await loadData();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        async function loadData() {
            try {
                const res = await fetch('data.json?t=' + Date.now());
                data = await res.json();

                // Init Site Info
                updateField('site-title', data.site.title);
                updateField('site-copyright', data.site.copyright);
                // Header Socials Init
                updateField('header-ig', data.site.header_social_instagram);
                updateField('header-link', data.site.header_social_link);
                updateField('header-email', data.site.header_social_email);
                updateField('site-bio', data.site.bio);

                // Init Bio Layout
                if (!data.site.bio_layout) data.site.bio_layout = {};
                updateField('bio-top', data.site.bio_layout.top);
                updateField('bio-left', data.site.bio_layout.padding_left);
                updateField('bio-width', data.site.bio_layout.width);
                updateField('bio-max-width', data.site.bio_layout.max_width);

                // Init Lists
                if (!data.site.contact_items) data.site.contact_items = [];
                renderContactList();

                // Init Contact Layout & Images
                if (!data.site.contact_info_layout) data.site.contact_info_layout = {};
                if (!data.site.contact_gallery_layout) data.site.contact_gallery_layout = {};
                updateField('c-info-top', data.site.contact_info_layout.top);
                updateField('c-info-left', data.site.contact_info_layout.left);
                updateField('c-info-width', data.site.contact_info_layout.width);

                updateField('c-gal-top', data.site.contact_gallery_layout.top);
                updateField('c-gal-left', data.site.contact_gallery_layout.left);
                updateField('c-gal-width', data.site.contact_gallery_layout.width);

                renderContactImagesEditor();

                if (!data.site.home_images) data.site.home_images = [];
                while (data.site.home_images.length < 5) data.site.home_images.push("");
                renderHomeImagesEditor();

                renderProjects();
            } catch (e) {
                console.error(e);
                alert("Failed to load data.json");
            }
        }

        function updateField(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val || '';
        }

        // --- CORE UPDATE FUNCTIONS ---

        function updateSiteData(key, val) {
            data.site[key] = val;
        }

        function updateBioLayout(key, val) {
            if (!data.site.bio_layout) data.site.bio_layout = {};
            data.site.bio_layout[key] = val;
        }

        // --- HOME IMAGES EDITOR ---

        function renderHomeImagesEditor() {
            const container = document.getElementById('home-images-list');
            container.innerHTML = '';

            const defaults = [
                { t: 2, l: 8, w: 35 },
                { t: 25, l: 38, w: 22 },
                { t: 6, l: 'Right 5%', w: 32 },
                { t: 35, l: 12, w: 20 },
                { t: 30, l: 65, w: 26 }
            ];

            data.site.home_images.forEach((item, i) => {
                if (i >= 5) return;
                const src = typeof item === 'string' ? item : item.src;
                const style = (typeof item === 'object' && item.style) ? item.style : { top: '', left: '', width: '' };
                const def = defaults[i] || { t: '', l: '', w: '' };

                const div = document.createElement('div');
                div.style.background = '#333';
                div.style.padding = '10px';
                div.style.borderRadius = '8px';
                div.style.textAlign = 'center';

                let previewSrc = src;
                if (src && !src.startsWith('http')) previewSrc = src + '?t=' + Date.now();

                div.innerHTML = `
                    <div style="font-size:11px; color:#aaa; margin-bottom:5px;">SLOT ${i + 1}</div>
                    <div style="width:100%; aspect-ratio:1/1; background:#000; margin-bottom:10px; border-radius:4px; overflow:hidden;">
                        <img src="${previewSrc}" style="width:100%; height:100%; object-fit:cover; opacity:${src ? 1 : 0.3}">
                    </div>
                    <button class="btn" style="font-size:10px; width:100%; margin-bottom:10px;" onclick="document.getElementById('home-upload-${i}').click()">REPLACE</button>
                    <input type="file" id="home-upload-${i}" style="display:none" onchange="uploadFile(this, (path) => updateHomeImage(${i}, path))">
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; border-top:1px solid #444; padding-top:10px;">
                        <div>
                            <label style="font-size:9px;">TOP %</label>
                            <input type="number" placeholder="Def: ${def.t}" value="${style.top || ''}" oninput="updateHomeStyle(${i}, 'top', this.value)" style="padding:4px; font-size:11px; width:100%; background:#222; border:1px solid #444; color:#fff;">
                        </div>
                        <div>
                            <label style="font-size:9px;">LEFT %</label>
                            <input type="${i === 2 ? 'text' : 'number'}" placeholder="Def: ${def.l}" value="${style.left || ''}" oninput="updateHomeStyle(${i}, 'left', this.value)" style="padding:4px; font-size:11px; width:100%; background:#222; border:1px solid #444; color:#fff;">
                        </div>
                        <div>
                            <label style="font-size:9px;">WIDTH %</label>
                            <input type="number" placeholder="Def: ${def.w}" value="${style.width || ''}" oninput="updateHomeStyle(${i}, 'width', this.value)" style="padding:4px; font-size:11px; width:100%; background:#222; border:1px solid #444; color:#fff;">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateHomeImage(index, path) {
            let current = data.site.home_images[index];
            if (typeof current === 'string') {
                data.site.home_images[index] = { src: path, style: {} };
            } else {
                current.src = path;
            }
            renderHomeImagesEditor();
        }

        function updateHomeStyle(index, key, val) {
            let current = data.site.home_images[index];
            if (typeof current === 'string') {
                current = { src: current, style: {} };
                data.site.home_images[index] = current;
            }
            if (!current.style) current.style = {};
            current.style[key] = val;
        }

        // --- CONTACT LIST ---

        function renderContactList() {
            const container = document.getElementById('contact-list-container');
            container.innerHTML = '';
            data.site.contact_items.forEach((item, i) => {
                const div = document.createElement('div');
                div.style.background = '#333';
                div.style.padding = '10px';
                div.style.borderRadius = '4px';
                div.style.display = 'flex';
                div.style.gap = '10px';
                div.style.alignItems = 'center';
                div.innerHTML = `
                    <div style="flex:1;">
                        <input type="text" placeholder="Label" value="${item.label}" oninput="updateContactItem(${i}, 'label', this.value)" style="margin-bottom:5px;">
                        <input type="text" placeholder="Value" value="${item.value}" oninput="updateContactItem(${i}, 'value', this.value)">
                    </div>
                    <div style="flex:1;">
                        <input type="text" placeholder="Link (Optional)" value="${item.link || ''}" oninput="updateContactItem(${i}, 'link', this.value)">
                    </div>
                     <div style="display:flex; flex-direction:column; gap:2px;">
                        <button class="btn" style="padding:2px 5px;" onclick="moveContactItem(${i}, -1)">‚ñ≤</button>
                        <button class="btn" style="padding:2px 5px;" onclick="moveContactItem(${i}, 1)">‚ñº</button>
                    </div>
                    <button class="btn btn-danger" style="padding:5px 10px;" onclick="removeContactItem(${i})">X</button>
                `;
                container.appendChild(div);
            });
        }
        function addContactItem() {
            if (!data.site.contact_items) data.site.contact_items = [];
            data.site.contact_items.push({ label: "New", value: "", link: "" });
            renderContactList();
        }
        function removeContactItem(index) {
            data.site.contact_items.splice(index, 1);
            renderContactList();
        }
        function moveContactItem(index, dir) {
            const target = index + dir;
            if (target >= 0 && target < data.site.contact_items.length) {
                [data.site.contact_items[index], data.site.contact_items[target]] = [data.site.contact_items[target], data.site.contact_items[index]];
                renderContactList();
            }
        }
        function updateContactItem(index, key, val) { data.site.contact_items[index][key] = val; }

        // --- PROJECTS ---

        function renderProjects() {
            const container = document.getElementById('projects-list');
            container.innerHTML = '';

            // Performance: Use DocumentFragment for batch DOM operations
            const fragment = document.createDocumentFragment();

            data.projects.forEach((proj, i) => {
                const layout = proj.layout || {};
                const galleryLayout = proj.gallery_layout || {};

                const div = document.createElement('div');
                div.className = 'project-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #333; padding-bottom:10px;">
                        <strong style="color:var(--accent);">${proj.title || 'Untitled'}</strong>
                        <div>
                            <button class="btn" onclick="moveProject(${i}, -1)">‚ñ≤</button>
                            <button class="btn" onclick="moveProject(${i}, 1)">‚ñº</button>
                            <button class="btn btn-danger" onclick="deleteProject(${i})">X</button>
                        </div>
                    </div>
                    <div class="row-inputs" style="margin-top:10px;">
                        <div><label>Title</label><input type="text" value="${proj.title}" oninput="updateProject(${i}, 'title', this.value)"></div>
                        <div><label>Year / Meta</label><input type="text" value="${proj.year}" oninput="updateProject(${i}, 'year', this.value)"></div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
                        <div style="background:#222; padding:10px; border-radius:4px; border:1px solid #333;">
                            <label style="color:#aaa;">Layout Control (Info Text)</label>
                            <div class="row-inputs" style="gap:5px;">
                                <div><label style="font-size:9px;">Top (px)</label><input type="number" placeholder="Def: 40" value="${layout.top || ''}" oninput="updateProjectLayout(${i}, 'top', this.value)" style="padding:4px; font-size:11px; width:100%;"></div>
                                <div><label style="font-size:9px;">Left (px)</label><input type="number" placeholder="Def: 0" value="${layout.left || ''}" oninput="updateProjectLayout(${i}, 'left', this.value)" style="padding:4px; font-size:11px; width:100%;"></div>
                                <div><label style="font-size:9px;">Width (%)</label><input type="number" placeholder="Def: 300px (Fixed)" value="${layout.width || ''}" oninput="updateProjectLayout(${i}, 'width', this.value)" style="padding:4px; font-size:11px; width:100%;"></div>
                            </div>
                        </div>
                        <div style="background:#222; padding:10px; border-radius:4px; border:1px solid #333;">
                            <label style="color:#aaa;">Layout Control (Gallery Images Unified)</label>
                            <div class="row-inputs" style="gap:5px;">
                                <div><label style="font-size:9px;">Top %</label><input type="number" placeholder="Def: 0" value="${galleryLayout.top || ''}" oninput="updateProjectGalleryLayout(${i}, 'top', this.value)" style="padding:4px; font-size:11px; width:100%;"></div>
                                <div><label style="font-size:9px;">Left %</label><input type="number" placeholder="Def: 0" value="${galleryLayout.left || ''}" oninput="updateProjectGalleryLayout(${i}, 'left', this.value)" style="padding:4px; font-size:11px; width:100%;"></div>
                                <div><label style="font-size:9px;">Width %</label><input type="number" placeholder="Def: 100" value="${galleryLayout.width || ''}" oninput="updateProjectGalleryLayout(${i}, 'width', this.value)" style="padding:4px; font-size:11px; width:100%;"></div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:15px;"><label>Description</label><textarea style="min-height:80px;" oninput="updateProject(${i}, 'description', this.value)">${proj.description || ''}</textarea></div>
                    <div style="margin-top:15px;"><label>Cover Image (List View)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <img src="${proj.image}" style="height:40px; border-radius:4px;">
                            <input type="file" onchange="uploadFile(this, (path) => updateProject(${i}, 'image', path))">
                        </div>
                    </div>

                    <div style="margin-top:15px;"><label>Gallery Images (Detail View)</label>
                        <div class="gallery-grid" id="gallery-grid-${i}"></div>
                        <button class="btn" style="margin-top:5px; font-size:10px;" onclick="document.getElementById('gallery-upload-${i}').click()">+ ADD PHOTO</button>
                        <input type="file" id="gallery-upload-${i}" style="display:none" multiple onchange="uploadFilesBatch(this, (paths) => addGalleryImagesBatch(${i}, paths))">
                    </div>
                `;
                fragment.appendChild(div);

                // Render Gallery Grid (Optimized with lazy loading)
                const grid = div.querySelector(`#gallery-grid-${i}`);
                const galleryFragment = document.createDocumentFragment();

                (proj.gallery || []).forEach((imgItem, imgIndex) => {
                    // Normalize
                    const src = typeof imgItem === 'string' ? imgItem : imgItem.src;
                    const caption = (typeof imgItem === 'object' && imgItem.caption) ? imgItem.caption : "";

                    const thumb = document.createElement('div');
                    thumb.className = 'img-thumb-container';
                    thumb.style.height = 'auto';
                    thumb.draggable = true;
                    thumb.dataset.projIndex = i;
                    thumb.dataset.imgIndex = imgIndex;
                    thumb.innerHTML = `
                        <img src="${src}" draggable="false" loading="lazy">
                        <input type="text" class="image-caption-input" placeholder="ËæìÂÖ•ÁÖßÁâáÊèèËø∞..." value="${caption}">
                        <button class="img-remove" onclick="removeGalleryImage(${i}, ${imgIndex})">√ó</button>
                    `;

                    // Optimized drag events with minimal DOM operations
                    thumb.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', JSON.stringify({ proj: i, img: imgIndex }));
                        // Use requestAnimationFrame to ensure smooth CSS transitions
                        requestAnimationFrame(() => thumb.classList.add('dragging'));
                    });

                    thumb.addEventListener('dragend', () => {
                        thumb.classList.remove('dragging');
                        // Clean up all drag-over states
                        grid.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    });

                    thumb.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        // Only add class if not already present (reduces DOM operations)
                        if (!thumb.classList.contains('drag-over')) {
                            thumb.classList.add('drag-over');
                        }
                    });

                    thumb.addEventListener('dragleave', (e) => {
                        // Only remove if we're actually leaving the element (not entering a child)
                        if (e.target === thumb || !thumb.contains(e.relatedTarget)) {
                            thumb.classList.remove('drag-over');
                        }
                    });

                    thumb.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        thumb.classList.remove('drag-over');

                        const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                        if (dragData.proj === i && dragData.img !== imgIndex) {
                            reorderGalleryImage(i, dragData.img, imgIndex);
                        }
                    });

                    // Attach debounced caption handler after DOM insertion
                    const captionInput = thumb.querySelector('.image-caption-input');
                    if (captionInput) {
                        captionInput.addEventListener('input', debounce((e) => {
                            updateGalleryCaption(i, imgIndex, e.target.value);
                        }, 500));
                    }

                    galleryFragment.appendChild(thumb);
                });

                // Batch insert all thumbnails
                grid.appendChild(galleryFragment);

                // Add drag hint
                const hint = document.createElement('div');
                hint.className = 'drag-hint';
                hint.textContent = 'üí° ÊãñÊãΩÁº©Áï•ÂõæÂèØË∞ÉÊï¥È°∫Â∫è';
                grid.parentNode.insertBefore(hint, grid.nextSibling);
            });

            // Performance: Batch append all projects at once
            container.appendChild(fragment);
        }

        function updateProject(index, key, val) {
            data.projects[index][key] = val;
            if (key === 'title' || key === 'image') renderProjects();
        }
        function updateProjectLayout(index, key, val) {
            if (!data.projects[index].layout) data.projects[index].layout = {};
            data.projects[index].layout[key] = val;
        }
        function updateProjectGalleryLayout(index, key, val) {
            if (!data.projects[index].gallery_layout) data.projects[index].gallery_layout = {};
            data.projects[index].gallery_layout[key] = val;
        }

        function addGalleryImage(idx, path) {
            if (!data.projects[idx].gallery) data.projects[idx].gallery = [];
            data.projects[idx].gallery.push(path);
            renderProjects();
        }

        function addGalleryImagesBatch(idx, paths) {
            if (!data.projects[idx].gallery) data.projects[idx].gallery = [];
            paths.forEach(p => data.projects[idx].gallery.push(p));
            renderProjects();
        }

        // Highly optimized reorder - pure DOM manipulation, no re-render
        function reorderGalleryImage(projIndex, fromIndex, toIndex) {
            const gallery = data.projects[projIndex].gallery;
            if (!gallery || fromIndex === toIndex) return;

            // Update data model
            const [movedItem] = gallery.splice(fromIndex, 1);
            gallery.splice(toIndex, 0, movedItem);

            // Direct DOM manipulation for instant visual feedback
            const grid = document.getElementById(`gallery-grid-${projIndex}`);
            if (!grid) return;

            const items = Array.from(grid.querySelectorAll('.img-thumb-container'));
            const movedEl = items[fromIndex];
            const targetEl = items[toIndex];

            if (!movedEl || !targetEl) return;

            // Move DOM element
            if (fromIndex < toIndex) {
                grid.insertBefore(movedEl, targetEl.nextSibling);
            } else {
                grid.insertBefore(movedEl, targetEl);
            }

            // Update all dataset indices and event handlers in a single pass
            const allItems = Array.from(grid.querySelectorAll('.img-thumb-container'));
            allItems.forEach((item, newIndex) => {
                item.dataset.imgIndex = newIndex;

                // Update caption input handler
                const captionInput = item.querySelector('.image-caption-input');
                if (captionInput) {
                    captionInput.setAttribute('oninput', `updateGalleryCaption(${projIndex}, ${newIndex}, this.value)`);
                }

                // Update remove button handler
                const removeBtn = item.querySelector('.img-remove');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeGalleryImage(${projIndex}, ${newIndex})`);
                }
            });
        }

        // New Batch Upload Helper
        async function uploadFilesBatch(input, callback) {
            if (!input.files || input.files.length === 0) return;

            const paths = [];
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/api/upload', { method: 'POST', body: formData });
                    if (res.ok) {
                        const json = await res.json();
                        paths.push(json.filepath);
                    }
                } catch (e) {
                    console.error("Upload failed for file " + i, e);
                }
            }

            if (paths.length > 0) {
                callback(paths);
            }
            input.value = ''; // Reset
        }

        function updateGalleryCaption(projIndex, imgIndex, val) {
            let item = data.projects[projIndex].gallery[imgIndex];
            if (typeof item === 'string') {
                data.projects[projIndex].gallery[imgIndex] = { src: item, caption: val };
            } else {
                item.caption = val;
            }
        }

        function removeGalleryImage(idx, imgIdx) {
            data.projects[idx].gallery.splice(imgIdx, 1);
            renderProjects();
        }
        function addNewProject() {
            data.projects.unshift({ id: "new-" + Date.now(), title: "NEW PROJECT", year: "2026", description: "...", image: "images/placeholder.jpg", gallery: [] });
            renderProjects();
        }
        // Delete with double-click confirmation (avoids browser confirm() blocking)
        let deleteConfirmState = { index: -1, timeout: null };
        function deleteProject(index) {
            if (deleteConfirmState.index === index) {
                // Second click - actually delete
                clearTimeout(deleteConfirmState.timeout);
                data.projects.splice(index, 1);
                deleteConfirmState = { index: -1, timeout: null };
                renderProjects();
            } else {
                // First click - show warning
                clearTimeout(deleteConfirmState.timeout);
                deleteConfirmState.index = index;

                // Visual feedback
                const btn = event.target;
                btn.textContent = 'Á°ÆÂÆö?';
                btn.style.width = '50px';

                // Reset after 2 seconds
                deleteConfirmState.timeout = setTimeout(() => {
                    deleteConfirmState = { index: -1, timeout: null };
                    btn.textContent = 'X';
                    btn.style.width = '';
                }, 2000);
            }
        }
        function moveProject(index, dir) {
            const target = index + dir;
            if (target >= 0 && target < data.projects.length) {
                [data.projects[index], data.projects[target]] = [data.projects[target], data.projects[index]];
                renderProjects();
            }
        }

        // --- UTILS ---

        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
        }


        function updateContactLayout(side, key, val) {
            const prop = side === 'info' ? 'contact_info_layout' : 'contact_gallery_layout';
            if (!data.site[prop]) data.site[prop] = {};
            data.site[prop][key] = val;
        }

        // Toggle between random and fixed contact images
        function toggleContactImageMode(isRandom) {
            if (!data.site) data.site = {};
            data.site.contact_random_mode = isRandom;

            // Update UI
            const toggle = document.getElementById('contact-random-toggle');
            const label = document.getElementById('contact-mode-label');
            const fixedSection = document.getElementById('contact-fixed-section');

            if (toggle) toggle.checked = isRandom;
            if (label) label.textContent = isRandom ? 'üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè (Â∑≤ÂºÄÂêØ)' : 'üñºÔ∏è Âõ∫ÂÆöÂõæÁâáÊ®°Âºè';
            if (fixedSection) fixedSection.style.opacity = isRandom ? '0.4' : '1';

            // If switching to random, clear fixed images
            if (isRandom) {
                data.site.contact_fixed_images = [];
                renderContactImagesEditor();
            }
        }

        function renderContactImagesEditor() {
            const container = document.getElementById('contact-images-list');
            container.innerHTML = '';
            if (!data.site.contact_fixed_images) data.site.contact_fixed_images = [];

            // Update toggle state based on current mode
            const isRandom = data.site.contact_random_mode === true ||
                (data.site.contact_fixed_images.filter(s => s).length === 0);
            const toggle = document.getElementById('contact-random-toggle');
            const label = document.getElementById('contact-mode-label');
            const fixedSection = document.getElementById('contact-fixed-section');

            if (toggle) toggle.checked = isRandom;
            if (label) label.textContent = isRandom ? 'üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè (Â∑≤ÂºÄÂêØ)' : 'üñºÔ∏è Âõ∫ÂÆöÂõæÁâáÊ®°Âºè';
            if (fixedSection) fixedSection.style.opacity = isRandom ? '0.4' : '1';

            // Ensure 3 slots
            for (let i = 0; i < 3; i++) {
                const src = data.site.contact_fixed_images[i] || "";
                const div = document.createElement('div');
                div.style.flex = '1';
                div.innerHTML = `
                    <div style="background:#000; height:100px; margin-bottom:5px; overflow:hidden; border-radius:4px;">
                        <img src="${src}" style="width:100%; height:100%; object-fit:cover; opacity:${src ? 1 : 0.3}">
                    </div>
                    ${src ? `<button class="btn btn-danger" style="width:100%; font-size:9px; padding:2px; margin-bottom:2px;" onclick="updateContactImage(${i}, '')">CLEAR (RANDOM)</button>` : ''}
                    <button class="btn" style="width:100%; font-size:10px; padding:5px;" onclick="document.getElementById('c-upload-${i}').click()">${src ? 'REPLACE' : 'SELECT FIXED'}</button>
                    <input type="file" id="c-upload-${i}" style="display:none" onchange="uploadFile(this, (path) => updateContactImage(${i}, path))">
                 `;
                container.appendChild(div);
            }
        }

        function updateContactImage(index, path) {
            if (!data.site.contact_fixed_images) data.site.contact_fixed_images = [];
            if (path === '') {
                data.site.contact_fixed_images[index] = "";
                // If all empty, maybe clear array? Logic handles empty string as "random" if slots not filled, 
                // but script.js checks if array length > 0.
                // Actually script.js checks: if (siteInfo.contact_fixed_images && ... length > 0)
                // If [ "", "managed", "" ] -> it might show empty, managed, empty.
                // script.js logic: slice(0,3).map. 
                // I should ensure script.js handles empty strings in array by picking random? 
                // Current script.js: `targetImages = siteInfo.contact_fixed_images.slice(0, 3).map...`
                // It doesn't fallback per slot. It falls back if valid images array not found.
                // I will tell user: "Fill all 3 for best results or Clear All to go back to Random".
            } else {
                data.site.contact_fixed_images[index] = path;
            }
            // Remove trailing empty strings to fallback to random if all clear
            if (data.site.contact_fixed_images.every(s => !s)) data.site.contact_fixed_images = [];

            renderContactImagesEditor();
        }

        async function uploadFile(input, callback) {
            if (!input.files || !input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.status === 'success') callback(json.filepath);
                else alert('Upload failed');
            } catch (e) { alert('Error uploading'); }
        }

        async function saveData() {
            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (json.status === 'success') alert('Saved!');
                else alert('Error: ' + json.message);
            } catch (e) { alert('Connection Error'); }
        }
    </script>
</body>

</html>