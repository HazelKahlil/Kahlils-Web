<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN | HAZEL (FIXED)</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <style>
        /* ========== Swiss Editorial CMS Theme - Premium Design ========== */
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=Space+Grotesk:wght@300;400;500;700&display=swap');

        :root {
            --bg: #ffffff;
            --sidebar-bg: #fcfcfc;
            --text: #000000;
            --text-muted: #999999;
            --border: #eeeeee;
            --border-heavy: #000000;
            --accent: #000000;
            --danger: #ff0000;
            --panel: #fdfdfd;
            --font-serif: 'Cormorant Garamond', serif;
            --font-sans: 'Space Grotesk', sans-serif;
        }

        * {
            box-sizing: border-box;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: var(--font-sans);
            margin: 0;
            padding: 0;
            line-height: 1.4;
        }

        /* ===== Layout: Management Portal ===== */
        #app {
            display: flex;
            min-height: 100vh;
        }

        /* ===== Sidebar (Swiss Style) ===== */
        aside {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border);
            padding: 60px 40px;
            position: fixed;
            height: 100vh;
            display: flex;
            flex-direction: column;
            gap: 60px;
        }

        .side-logo {
            font-family: var(--font-serif);
            font-size: 36px;
            font-weight: 700;
            line-height: 1;
            margin: 0;
        }

        .side-logo span {
            display: block;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 4px;
            color: var(--text-muted);
            margin-top: 10px;
            font-family: var(--font-sans);
            font-weight: 400;
        }

        .nav-vertical {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .tab-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-family: var(--font-serif);
            font-size: 24px;
            text-align: left;
            cursor: pointer;
            padding: 0;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text);
            transform: translateX(5px);
        }

        .tab-btn.active {
            color: var(--text);
            font-style: italic;
            font-weight: 600;
        }

        .tab-btn.active::before {
            content: '';
            position: absolute;
            left: -20px;
            top: 50%;
            width: 10px;
            height: 1px;
            background: var(--text);
        }

        /* ===== Main Content Area ===== */
        main {
            flex: 1;
            margin-left: 300px;
            padding: 80px 10%;
            background: #ffffff;
        }

        .page-title {
            font-family: var(--font-serif);
            font-size: 64px;
            font-weight: 400;
            margin-bottom: 60px;
            border-bottom: 2px solid var(--text);
            padding-bottom: 20px;
        }

        .section-title {
            font-family: var(--font-serif);
            font-size: 32px;
            font-weight: 600;
            margin: 60px 0 30px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .section-title span {
            font-family: var(--font-sans);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
        }

        /* ===== Forms (Swiss Minimalist) ===== */
        .form-group {
            margin-bottom: 40px;
            background: var(--panel);
            padding: 0px 0px 40px;
            border-bottom: 1px solid var(--border);
        }

        label {
            display: block;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            margin-bottom: 15px;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"],
        textarea {
            width: 100%;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 15px 0;
            border-left: none;
            border-right: none;
            border-top: none;
            font-size: 18px;
            font-family: var(--font-serif);
            transition: all 0.3s ease;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-bottom-color: var(--text);
        }

        /* ===== Buttons ===== */
        .btn {
            background: var(--text);
            color: #fff;
            border: none;
            padding: 18px 30px;
            font-family: var(--font-sans);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #333;
            letter-spacing: 4px;
        }

        .btn-danger {
            background: transparent;
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: var(--danger);
            color: #fff;
            letter-spacing: 2px;
        }

        /* ===== Project List / Gallery ===== */
        .project-item {
            border-bottom: 1px solid var(--text);
            padding: 60px 0;
            display: flex;
            flex-direction: column;
            gap: 40px;
        }

        .img-thumb-container {
            border: 1px solid var(--border);
            padding: 15px;
            transition: all 0.3s ease;
            position: relative;
        }

        .img-thumb-container:hover {
            border-color: var(--text);
        }

        .img-thumb-container img {
            width: 100%;
            height: 120px;
            /* Smaller height for dense grid */
            object-fit: contain;
            /* Show full image, don't crop */
            background: #f5f5f5;
            /* Light bg for aspect ratio padding */
            filter: grayscale(100%);
            transition: all 0.5s ease;
        }

        .img-thumb-container:hover img {
            filter: grayscale(0%);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            /* ~5-6 columns on desktop */
            gap: 15px;
            /* Tighter gap */
        }

        /* Drag & Drop States */
        .img-thumb-container {
            cursor: grab;
        }

        .img-thumb-container:active {
            cursor: grabbing;
        }

        .img-thumb-container.dragging {
            opacity: 0.4;
            transform: scale(0.95);
            border-style: dashed;
        }

        .img-thumb-container.drag-over {
            border-color: var(--text);
            transform: scale(1.02);
            box-shadow: 0 0 0 2px var(--text);
        }

        /* Image Remove Button */
        .img-remove {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--danger);
            color: #fff;
            border: none;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .img-thumb-container:hover .img-remove {
            opacity: 1;
        }

        /* Image Caption Input */
        .image-caption-input {
            width: 100%;
            background: transparent;
            border: none;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            padding: 8px 0;
            margin-top: 10px;
            font-family: var(--font-sans);
        }

        .image-caption-input:focus {
            outline: none;
            border-bottom-color: var(--text);
        }

        /* Drag Hint */
        .drag-hint {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 10px;
            font-style: italic;
        }

        /* Language Toggle */
        .lang-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 200;
            display: flex;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .lang-toggle button {
            background: transparent;
            border: none;
            padding: 8px 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: var(--font-sans);
        }

        .lang-toggle button.active {
            background: var(--text);
            color: #fff;
        }

        .lang-toggle button:not(.active) {
            color: var(--text-muted);
        }

        .lang-toggle button:not(.active):hover {
            background: var(--border);
        }

        /* ===== Sticky Footer Action ===== */
        .sticky-actions {
            position: fixed;
            bottom: 40px;
            right: 40px;
            z-index: 100;
        }

        .btn-save-all {
            box-shadow: 20px 20px 0px rgba(0, 0, 0, 0.1);
        }

        /* ===== Login Overlay (Swiss Minimal) ===== */
        #login-overlay {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        #login-overlay h2 {
            font-family: var(--font-serif);
            font-size: 80px;
            font-weight: 400;
            margin: 0;
        }

        #login-overlay input {
            width: 300px;
            text-align: center;
            font-size: 24px;
            border-bottom: 2px solid #000;
        }

        /* ===== Scrollbar ===== */
        ::-webkit-scrollbar {
            width: 5px;
        }

        ::-webkit-scrollbar-track {
            background: #fff;
        }

        ::-webkit-scrollbar-thumb {
            background: #000;
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <h2>ACCESS</h2>
        <input type="password" id="password-input" placeholder="Password"
            onkeypress="if(event.key==='Enter')checkAuth()">
        <button class="btn" onclick="checkAuth()">Enter Portal</button>
        <p id="login-error" style="display:none; color: red; font-size: 14px;">Access Denied</p>
    </div>

    <!-- MAIN APP -->
    <div id="app" style="display:none;">

        <!-- Language Toggle -->
        <div class="lang-toggle">
            <button class="active" onclick="setLang('en')">EN</button>
            <button onclick="setLang('zh')">‰∏≠</button>
        </div>

        <aside>
            <div class="side-logo">
                Hazel.
                <span>Management Suite</span>
            </div>

            <nav class="nav-vertical">
                <button class="tab-btn active" onclick="switchTab('home')">Index</button>
                <button class="tab-btn" onclick="switchTab('portfolios')">Collections</button>
                <button class="tab-btn" onclick="switchTab('info')">Biography</button>
                <button class="tab-btn" onclick="switchTab('contact')">Dialogue</button>
            </nav>

            <div style="margin-top: auto;">
                <a href="index.html" target="_blank"
                    style="text-decoration: none; color: #000; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 2px;">View
                    Live Site ‚Üó</a>
            </div>
        </aside>

        <main>
            <div class="page-title">Index</div>
            <div class="container">

                <!-- TAB: HOME -->
                <div id="tab-home" class="tab-content active">
                    <div class="section-title"><span>Global Settings</span></div>
                    <div class="form-group">
                        <div class="row-inputs">
                            <div>
                                <label>Site Main Title</label>
                                <input type="text" id="site-title" oninput="updateSiteData('title', this.value)">
                            </div>
                            <div>
                                <label>Footer Copyright</label>
                                <input type="text" id="site-copyright"
                                    oninput="updateSiteData('copyright', this.value)">
                            </div>
                        </div>

                        <!-- New Header Socials -->
                        <div class="row-inputs" style="margin-top:10px;">
                            <div>
                                <label>Header: Instagram URL</label>
                                <input type="text" id="header-ig"
                                    oninput="updateSiteData('header_social_instagram', this.value)">
                            </div>
                        </div>
                        <div class="row-inputs" style="margin-top:10px;">
                            <div>
                                <label>Header: Link URL (Chain)</label>
                                <input type="text" id="header-link"
                                    oninput="updateSiteData('header_social_link', this.value)">
                            </div>
                            <div>
                                <label>Header: Email Address</label>
                                <input type="text" id="header-email"
                                    oninput="updateSiteData('header_social_email', this.value)">
                            </div>
                        </div>
                    </div>

                    <div class="section-title"><span>Home Hero Images</span></div>
                    <div class="form-group">
                        <label style="margin-bottom:20px;">Use the inputs below to fine-tune position (Top/Left) and
                            Size
                            (Width)</label>
                        <div id="home-images-list"
                            style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:20px;">
                        </div>
                    </div>
                </div>

                <!-- TAB: PORTFOLIOS -->
                <div id="tab-portfolios" class="tab-content">
                    <button class="btn btn-block"
                        style="margin-bottom:20px; border:1px dashed #666; background:transparent; color:#888;"
                        onclick="addNewProject()">+ NEW PROJECT</button>
                    <div id="projects-list"></div>
                </div>

                <!-- TAB: INFO (BIO) -->
                <div id="tab-info" class="tab-content">
                    <div class="section-title"><span>Biography Content</span></div>
                    <div class="form-group">
                        <label>Main Text (Paragraphs are preserved)</label>
                        <textarea id="site-bio" oninput="updateSiteData('bio', this.value)"></textarea>
                    </div>

                    <div class="section-title"><span>Layout Control</span></div>
                    <div class="form-group">
                        <div class="row-inputs">
                            <div>
                                <label>Padding Top (px)</label>
                                <input type="number" id="bio-top" placeholder="Default: 40"
                                    oninput="updateBioLayout('top', this.value)">
                            </div>
                            <div>
                                <label>Padding Left (px)</label>
                                <input type="number" id="bio-left" placeholder="Default: 60"
                                    oninput="updateBioLayout('padding_left', this.value)">
                            </div>
                            <div>
                                <label>Width (%)</label>
                                <input type="number" id="bio-width" placeholder="Default: 60"
                                    oninput="updateBioLayout('width', this.value)">
                            </div>
                            <div>
                                <label>Max Width (px)</label>
                                <input type="number" id="bio-max-width" placeholder="Default: 600"
                                    oninput="updateBioLayout('max_width', this.value)">
                            </div>
                        </div>
                        <p style="font-size:10px; color:#666; margin-top:10px;">Adjust these values to position the text
                            block exactly where you want it. Clear to reset to defaults.</p>
                    </div>
                </div>

                <!-- TAB: CONTACT -->
                <div id="tab-contact" class="tab-content">
                    <div class="section-title"><span>Contact Details</span></div>
                    <div class="form-group">
                        <div id="contact-list-container" style="display:flex; flex-direction:column; gap:10px;"></div>
                        <button class="btn" onclick="addContactItem()" style="margin-top:10px;">+ Add Contact
                            Row</button>
                    </div>

                    <div class="section-title"><span>Layout Control</span></div>
                    <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div>
                            <label style="color:#aaa;">Info Side (Left)</label>
                            <div class="row-inputs" style="flex-direction:column; gap:5px;">
                                <div><label style="font-size:9px;">Top px</label><input type="number" id="c-info-top"
                                        placeholder="Def: 40" oninput="updateContactLayout('info', 'top', this.value)"
                                        style="padding:4px; font-size:11px;"></div>
                                <div><label style="font-size:9px;">Left px</label><input type="number" id="c-info-left"
                                        placeholder="Def: 0" oninput="updateContactLayout('info', 'left', this.value)"
                                        style="padding:4px; font-size:11px;"></div>
                                <div><label style="font-size:9px;">Width %</label><input type="number" id="c-info-width"
                                        placeholder="Def: 45" oninput="updateContactLayout('info', 'width', this.value)"
                                        style="padding:4px; font-size:11px;"></div>
                            </div>
                        </div>
                        <div>
                            <label style="color:#aaa;">Gallery Side (Right)</label>
                            <div class="row-inputs" style="flex-direction:column; gap:5px;">
                                <div><label style="font-size:9px;">Top px</label><input type="number" id="c-gal-top"
                                        placeholder="Def: 40"
                                        oninput="updateContactLayout('gallery', 'top', this.value)"
                                        style="padding:4px; font-size:11px;"></div>
                                <div><label style="font-size:9px;">Margin Left px</label><input type="number"
                                        id="c-gal-left" placeholder="Def: 0"
                                        oninput="updateContactLayout('gallery', 'left', this.value)"
                                        style="padding:4px; font-size:11px;"></div>
                                <div><label style="font-size:9px;">Width %</label><input type="number" id="c-gal-width"
                                        placeholder="Def: 50"
                                        oninput="updateContactLayout('gallery', 'width', this.value)"
                                        style="padding:4px; font-size:11px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">Contact Images (Right Side)</div>
                    <div class="form-group">
                        <!-- Mode Toggle -->
                        <div style="margin-bottom:15px; padding:15px; background:#fff; border:1px solid #eee;">
                            <label style="display:flex; align-items:center; cursor:pointer;">
                                <input type="checkbox" id="contact-random-toggle"
                                    onchange="toggleContactImageMode(this.checked)"
                                    style="width:18px; height:18px; margin-right:12px; cursor:pointer; accent-color:#000;">
                                <span id="contact-mode-label" style="font-size:12px; font-weight:500;">üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè</span>
                            </label>
                            <div id="contact-mode-hint" style="font-size:10px; color:#999; margin-top:8px;">
                                ÂºÄÂêØÂêéÊØèÊ¨°Âà∑Êñ∞È°µÈù¢ÊòæÁ§∫ÈöèÊú∫ÂõæÁâáÔºõÂÖ≥Èó≠Âêé‰ΩøÁî®‰∏ãÊñπÊåáÂÆöÁöÑÂõ∫ÂÆöÂõæÁâá
                            </div>
                        </div>

                        <!-- Fixed Images Section (shown when random is off) -->
                        <div id="contact-fixed-section">
                            <label style="margin-bottom:10px; font-size:10px; color:#888;">Âõ∫ÂÆöÂõæÁâáËÆæÁΩÆÔºà‰ªÖÂú®ÂÖ≥Èó≠ÈöèÊú∫Ê®°ÂºèÊó∂ÁîüÊïàÔºâ</label>
                            <div id="contact-images-list" style="display:flex; gap:10px;"></div>
                        </div>
                    </div>
                </div>

            </div>

        </main>

        <!-- FOOTER -->
        <div class="sticky-actions">
            <button class="btn btn-save-all" onclick="saveData()">SAVE CHANGES</button>
            <button class="btn btn-save-all" onclick="publishData()"
                style="background: #fff; color: #000; border: 1px solid #000; margin-left:10px;">
                PUBLISH TO LIVE
            </button>
        </div>
    </div>

    <script>
        // ... (data init)

        async function publishData() {
            const btn = document.querySelectorAll('.btn-save-all')[1]; // The second button
            const originalText = btn.textContent;

            if (!confirm('This will push all changes to the live website (GitHub). Continue?')) return;

            btn.textContent = 'PUBLISHING...';
            btn.disabled = true;

            try {
                const response = await fetch('/api/publish', {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.status === 'success') {
                    alert('‚úÖ ' + result.message);
                } else {
                    alert('‚ùå Publish Failed: ' + result.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error publishing: ' + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }
        let data = { site: {}, projects: [] };
        let currentLang = 'en';

        // i18n Translations
        const i18n = {
            en: {
                // Sidebar
                'nav.index': 'Index',
                'nav.collections': 'Collections',
                'nav.biography': 'Biography',
                'nav.dialogue': 'Dialogue',
                'nav.viewSite': 'View Live Site ‚Üó',
                'logo.subtitle': 'Management Suite',
                // Page Titles
                'page.index': 'Index',
                'page.collections': 'Collections',
                'page.biography': 'Biography',
                'page.dialogue': 'Dialogue',
                // Section Titles
                'section.globalSettings': 'Global Settings',
                'section.heroImages': 'Home Hero Images',
                'section.bioContent': 'Biography Content',
                'section.layoutControl': 'Layout Control',
                'section.contactDetails': 'Contact Details',
                'section.contactImages': 'Contact Images',
                // Labels
                'label.siteTitle': 'Site Main Title',
                'label.copyright': 'Footer Copyright',
                'label.instagram': 'Header: Instagram URL',
                'label.linkUrl': 'Header: Link URL (Chain)',
                'label.email': 'Header: Email Address',
                'label.bioText': 'Main Text (Paragraphs are preserved)',
                'label.paddingTop': 'Padding Top (px)',
                'label.paddingLeft': 'Padding Left (px)',
                'label.width': 'Width (%)',
                'label.maxWidth': 'Max Width (px)',
                // Buttons
                'btn.save': 'SAVE CHANGES',
                'btn.publish': 'PUBLISH TO LIVE',
                'btn.newProject': '+ NEW PROJECT',
                'btn.addContact': '+ Add Contact Row',
                'btn.enter': 'Enter Portal',
                // Misc
                'hint.dragReorder': 'Drag to reorder images',
                'login.title': 'ACCESS',
                'login.error': 'Access Denied'
            },
            zh: {
                // Sidebar
                'nav.index': 'È¶ñÈ°µ',
                'nav.collections': '‰ΩúÂìÅÈõÜ',
                'nav.biography': 'ÁÆÄ‰ªã',
                'nav.dialogue': 'ËÅîÁ≥ª',
                'nav.viewSite': 'Êü•ÁúãÁΩëÁ´ô ‚Üó',
                'logo.subtitle': 'ÂÜÖÂÆπÁÆ°ÁêÜÁ≥ªÁªü',
                // Page Titles
                'page.index': 'È¶ñÈ°µËÆæÁΩÆ',
                'page.collections': '‰ΩúÂìÅÈõÜÁÆ°ÁêÜ',
                'page.biography': '‰∏™‰∫∫ÁÆÄ‰ªã',
                'page.dialogue': 'ËÅîÁ≥ªÊñπÂºè',
                // Section Titles
                'section.globalSettings': 'ÂÖ®Â±ÄËÆæÁΩÆ',
                'section.heroImages': 'È¶ñÈ°µÂ§ßÂõæ',
                'section.bioContent': 'ÁÆÄ‰ªãÂÜÖÂÆπ',
                'section.layoutControl': 'Â∏ÉÂ±ÄÊéßÂà∂',
                'section.contactDetails': 'ËÅîÁ≥ª‰ø°ÊÅØ',
                'section.contactImages': 'ËÅîÁ≥ªÈ°µÂõæÁâá',
                // Labels
                'label.siteTitle': 'ÁΩëÁ´ôÊ†áÈ¢ò',
                'label.copyright': 'Â∫ïÈÉ®ÁâàÊùÉ',
                'label.instagram': 'Instagram ÈìæÊé•',
                'label.linkUrl': 'ÈìæÊé•Âú∞ÂùÄ',
                'label.email': 'ÈÇÆÁÆ±Âú∞ÂùÄ',
                'label.bioText': 'ÁÆÄ‰ªãÊ≠£ÊñáÔºà‰øùÁïôÊÆµËêΩÊ†ºÂºèÔºâ',
                'label.paddingTop': 'È°∂ÈÉ®Èó¥Ë∑ù (px)',
                'label.paddingLeft': 'Â∑¶‰æßÈó¥Ë∑ù (px)',
                'label.width': 'ÂÆΩÂ∫¶ (%)',
                'label.maxWidth': 'ÊúÄÂ§ßÂÆΩÂ∫¶ (px)',
                // Buttons
                'btn.save': '‰øùÂ≠òÊõ¥Êîπ',
                'btn.publish': 'ÂèëÂ∏ÉÂà∞Á∫ø‰∏ä',
                'btn.newProject': '+ Êñ∞Âª∫È°πÁõÆ',
                'btn.addContact': '+ Ê∑ªÂä†ËÅîÁ≥ªÊñπÂºè',
                'btn.enter': 'ËøõÂÖ•Á≥ªÁªü',
                // Misc
                'hint.dragReorder': 'ÊãñÊãΩË∞ÉÊï¥È°∫Â∫è',
                'login.title': 'ËÆøÈóÆÈ™åËØÅ',
                'login.error': 'ÂØÜÁ†ÅÈîôËØØ'
            }
        };

        function setLang(lang) {
            currentLang = lang;
            // Update toggle buttons
            document.querySelectorAll('.lang-toggle button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes(lang === 'en' ? 'EN' : '‰∏≠'));
            });
            // Apply translations
            applyTranslations();
            localStorage.setItem('adminLang', lang);
        }

        function t(key) {
            return i18n[currentLang][key] || key;
        }

        function applyTranslations() {
            // Sidebar Nav
            const navBtns = document.querySelectorAll('.nav-vertical .tab-btn');
            if (navBtns[0]) navBtns[0].textContent = t('nav.index');
            if (navBtns[1]) navBtns[1].textContent = t('nav.collections');
            if (navBtns[2]) navBtns[2].textContent = t('nav.biography');
            if (navBtns[3]) navBtns[3].textContent = t('nav.dialogue');

            // Sidebar Logo Subtitle
            const logoSubtitle = document.querySelector('.side-logo span');
            if (logoSubtitle) logoSubtitle.textContent = t('logo.subtitle');

            // View Site Link
            const viewSiteLink = document.querySelector('aside a[href="index.html"]');
            if (viewSiteLink) viewSiteLink.textContent = t('nav.viewSite');

            // Page Title
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    const tabId = activeTab.id.replace('tab-', '');
                    const titles = { 'home': 'page.index', 'portfolios': 'page.collections', 'info': 'page.biography', 'contact': 'page.dialogue' };
                    pageTitle.textContent = t(titles[tabId] || 'page.index');
                }
            }

            // Save & Publish Buttons
            const footerBtns = document.querySelectorAll('.btn-save-all');
            if (footerBtns[0]) footerBtns[0].textContent = t('btn.save');
            if (footerBtns[1]) footerBtns[1].textContent = t('btn.publish');

            // New Project Button
            const newProjectBtn = document.querySelector('#tab-portfolios .btn-block');
            if (newProjectBtn) newProjectBtn.textContent = t('btn.newProject');

            // Login
            const loginTitle = document.querySelector('#login-overlay h2');
            if (loginTitle) loginTitle.textContent = t('login.title');
            const loginBtn = document.querySelector('#login-overlay .btn');
            if (loginBtn) loginBtn.textContent = t('btn.enter');
        }


        // Performance: Debounce for input handlers
        function debounce(func, wait = 300) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        async function checkAuth() {
            if (document.getElementById('password-input').value === 'hazel2026') {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('app').style.display = 'flex';

                // Restore saved language
                const savedLang = localStorage.getItem('adminLang') || 'en';
                setLang(savedLang);

                await loadData();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        async function loadData() {
            try {
                const res = await fetch('/data.json?t=' + Date.now());
                data = await res.json();

                // Init Site Info
                updateField('site-title', data.site.title);
                updateField('site-copyright', data.site.copyright);
                // Header Socials Init
                updateField('header-ig', data.site.header_social_instagram);
                updateField('header-link', data.site.header_social_link);
                updateField('header-email', data.site.header_social_email);
                updateField('site-bio', data.site.bio);

                // Init Bio Layout
                if (!data.site.bio_layout) data.site.bio_layout = {};
                updateField('bio-top', data.site.bio_layout.top);
                updateField('bio-left', data.site.bio_layout.padding_left);
                updateField('bio-width', data.site.bio_layout.width);
                updateField('bio-max-width', data.site.bio_layout.max_width);

                // Init Lists
                if (!data.site.contact_items) data.site.contact_items = [];
                renderContactList();

                // Init Contact Layout & Images
                if (!data.site.contact_info_layout) data.site.contact_info_layout = {};
                if (!data.site.contact_gallery_layout) data.site.contact_gallery_layout = {};
                updateField('c-info-top', data.site.contact_info_layout.top);
                updateField('c-info-left', data.site.contact_info_layout.left);
                updateField('c-info-width', data.site.contact_info_layout.width);

                updateField('c-gal-top', data.site.contact_gallery_layout.top);
                updateField('c-gal-left', data.site.contact_gallery_layout.left);
                updateField('c-gal-width', data.site.contact_gallery_layout.width);

                renderContactImagesEditor();

                if (!data.site.home_images) data.site.home_images = [];
                while (data.site.home_images.length < 5) data.site.home_images.push("");
                renderHomeImagesEditor();

                renderProjects();
            } catch (e) {
                console.error(e);
                alert("Failed to load data.json");
            }
        }

        function updateField(id, val) {
            const el = document.getElementById(id);
            if (el) el.value = val || '';
        }

        // --- CORE UPDATE FUNCTIONS ---

        function updateSiteData(key, val) {
            data.site[key] = val;
        }

        function updateBioLayout(key, val) {
            if (!data.site.bio_layout) data.site.bio_layout = {};
            data.site.bio_layout[key] = val;
        }

        // --- HOME IMAGES EDITOR ---

        function renderHomeImagesEditor() {
            const container = document.getElementById('home-images-list');
            container.innerHTML = '';

            const defaults = [
                { t: 2, l: 8, w: 35 },
                { t: 25, l: 38, w: 22 },
                { t: 6, l: 'Right 5%', w: 32 },
                { t: 35, l: 12, w: 20 },
                { t: 30, l: 65, w: 26 }
            ];

            data.site.home_images.forEach((item, i) => {
                if (i >= 5) return;
                const src = typeof item === 'string' ? item : item.src;
                const style = (typeof item === 'object' && item.style) ? item.style : { top: '', left: '', width: '' };
                const def = defaults[i] || { t: '', l: '', w: '' };

                const div = document.createElement('div');
                div.style.background = '#fff';
                div.style.padding = '15px';
                div.style.border = '1px solid #eee';
                div.style.textAlign = 'center';
                div.style.display = 'flex';
                div.style.flexDirection = 'column';

                // PREVIEW PATH FIX
                let previewSrc = '';
                if (src) {
                    if (src.startsWith('http') || src.startsWith('/')) {
                        previewSrc = src;
                    } else if (src.startsWith('images/')) {
                        previewSrc = '/' + src;
                    } else {
                        previewSrc = '/images/' + src;
                    }
                    previewSrc += '?t=' + Date.now();
                }

                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <span style="font-size:11px; color:#999; font-weight:700; letter-spacing:1px;">SLOT ${i + 1}</span>
                        <div style="display:flex; gap:5px;">
                            ${i > 0 ? `<button onclick="moveHomeImage(${i}, -1)" style="cursor:pointer; border:1px solid #ddd; background:#fff; padding:2px 6px;">‚Üê</button>` : ''}
                            ${i < 4 ? `<button onclick="moveHomeImage(${i}, 1)" style="cursor:pointer; border:1px solid #ddd; background:#fff; padding:2px 6px;">‚Üí</button>` : ''}
                        </div>
                    </div>
                    
                    <div style="width:100%; aspect-ratio:1/1; background:#f9f9f9; margin-bottom:10px; overflow:hidden; border:1px solid #eee; position:relative; display:flex; align-items:center; justify-content:center;">
                        ${previewSrc ?
                        `<img src="${previewSrc}" style="width:100%; height:100%; object-fit:contain; background:#f0f0f0;">` :
                        `<span style="color:#ccc; font-size:10px;">NO IMAGE</span>`
                    }
                    </div>
                    
                    <button class="btn" style="font-size:10px; width:100%; margin-bottom:10px;" onclick="document.getElementById('home-upload-${i}').click()">
                        ${src ? 'REPLACE' : 'UPLOAD'}
                    </button>
                    <input type="file" id="home-upload-${i}" style="display:none" onchange="uploadFile(this, (path) => updateHomeImage(${i}, path))">
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px; border-top:1px solid #eee; padding-top:10px; margin-top:auto;">
                        <div>
                            <label style="font-size:9px; color:#999; display:block;">TOP %</label>
                            <input type="text" placeholder="Def: ${def.t}" value="${style.top || ''}" oninput="updateHomeStyle(${i}, 'top', this.value)" style="width:100%; padding:4px; font-size:11px; border:1px solid #ddd; text-align:center;">
                        </div>
                        <div>
                            <label style="font-size:9px; color:#999; display:block;">LEFT %</label>
                            <input type="text" placeholder="Def: ${def.l}" value="${style.left || ''}" oninput="updateHomeStyle(${i}, 'left', this.value)" style="width:100%; padding:4px; font-size:11px; border:1px solid #ddd; text-align:center;">
                        </div>
                        <div>
                            <label style="font-size:9px; color:#999; display:block;">WIDTH %</label>
                            <input type="text" placeholder="Def: ${def.w}" value="${style.width || ''}" oninput="updateHomeStyle(${i}, 'width', this.value)" style="width:100%; padding:4px; font-size:11px; border:1px solid #ddd; text-align:center;">
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function moveHomeImage(index, direction) {
            const newIndex = index + direction;
            if (newIndex < 0 || newIndex >= data.site.home_images.length) return;
            if (newIndex >= 5) return; // Keep it within 5 slots

            // Swap
            const temp = data.site.home_images[index];
            data.site.home_images[index] = data.site.home_images[newIndex];
            data.site.home_images[newIndex] = temp;

            renderHomeImagesEditor();
        }

        function updateHomeImage(index, path) {
            let current = data.site.home_images[index];
            if (typeof current === 'string') {
                data.site.home_images[index] = { src: path, style: {} };
            } else {
                current.src = path;
            }
            renderHomeImagesEditor();
        }

        function updateHomeStyle(index, key, val) {
            let current = data.site.home_images[index];
            if (typeof current === 'string') {
                current = { src: current, style: {} };
                data.site.home_images[index] = current;
            }
            if (!current.style) current.style = {};
            current.style[key] = val;
        }

        // --- CONTACT LIST ---

        function renderContactList() {
            const container = document.getElementById('contact-list-container');
            container.innerHTML = '';
            data.site.contact_items.forEach((item, i) => {
                const div = document.createElement('div');
                div.style.background = '#fff';
                div.style.padding = '20px';
                div.style.border = '1px solid #eee';
                div.style.display = 'flex';
                div.style.gap = '20px';
                div.style.alignItems = 'center';
                div.innerHTML = `
                    <div style="flex:1;">
                        <input type="text" placeholder="Label" value="${item.label}" oninput="updateContactItem(${i}, 'label', this.value)" style="margin-bottom:10px;">
                        <input type="text" placeholder="Value" value="${item.value}" oninput="updateContactItem(${i}, 'value', this.value)">
                    </div>
                    <div style="flex:1;">
                        <input type="text" placeholder="Link (Optional)" value="${item.link || ''}" oninput="updateContactItem(${i}, 'link', this.value)">
                    </div>
                     <div style="display:flex; flex-direction:column; gap:4px;">
                        <button class="btn" style="padding:4px 8px; background:#fff; border:1px solid #000;" onclick="moveContactItem(${i}, -1)">‚ñ≤</button>
                        <button class="btn" style="padding:4px 8px; background:#fff; border:1px solid #000;" onclick="moveContactItem(${i}, 1)">‚ñº</button>
                    </div>
                    <button class="btn btn-danger" style="padding:8px 12px;" onclick="removeContactItem(${i})">X</button>
                `;
                container.appendChild(div);
            });
        }
        function addContactItem() {
            if (!data.site.contact_items) data.site.contact_items = [];
            data.site.contact_items.push({ label: "New", value: "", link: "" });
            renderContactList();
        }
        function removeContactItem(index) {
            data.site.contact_items.splice(index, 1);
            renderContactList();
        }
        function moveContactItem(index, dir) {
            const target = index + dir;
            if (target >= 0 && target < data.site.contact_items.length) {
                [data.site.contact_items[index], data.site.contact_items[target]] = [data.site.contact_items[target], data.site.contact_items[index]];
                renderContactList();
            }
        }
        function updateContactItem(index, key, val) { data.site.contact_items[index][key] = val; }

        // --- PROJECTS ---

        function renderProjects() {
            const container = document.getElementById('projects-list');
            container.innerHTML = '';

            // Performance: Use DocumentFragment for batch DOM operations
            const fragment = document.createDocumentFragment();

            data.projects.forEach((proj, i) => {
                const layout = proj.layout || {};
                const galleryLayout = proj.gallery_layout || {};

                const div = document.createElement('div');
                div.className = 'project-item';
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #000; padding-bottom:15px;">
                        <strong style="font-family:var(--font-serif); font-size:24px;">${proj.title || 'Untitled'}</strong>
                        <div style="display:flex; gap:8px;">
                            <button class="btn" style="background:#fff; border:1px solid #000; padding:6px 12px; display:flex; align-items:center; justify-content:center;" onclick="moveProject(${i}, -1)" title="Move Up">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg>
                            </button>
                            <button class="btn" style="background:#fff; border:1px solid #000; padding:6px 12px; display:flex; align-items:center; justify-content:center;" onclick="moveProject(${i}, 1)" title="Move Down">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></svg>
                            </button>
                            <button class="btn btn-danger" style="padding:6px 12px; font-family:Arial, sans-serif; font-weight:bold;" onclick="deleteProject(${i})" title="Delete Project">DEL</button>
                        </div>
                    </div>
                    <div class="row-inputs" style="margin-top:15px;">
                        <div><label>Title</label><input type="text" value="${proj.title}" oninput="updateProject(${i}, 'title', this.value)"></div>
                        <div><label>Year / Meta</label><input type="text" value="${proj.year}" oninput="updateProject(${i}, 'year', this.value)"></div>
                    </div>
                    
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
                        <div style="background:#fff; padding:15px; border:1px solid #eee;">
                            <label style="color:#999; font-size:10px;">Layout Control (Info Text)</label>
                            <div class="row-inputs" style="gap:8px; margin-top:10px;">
                                <div><label style="font-size:9px; color:#999;">Top (px)</label><input type="number" placeholder="Def: 40" value="${layout.top || ''}" oninput="updateProjectLayout(${i}, 'top', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                <div><label style="font-size:9px; color:#999;">Left (px)</label><input type="number" placeholder="Def: 0" value="${layout.left || ''}" oninput="updateProjectLayout(${i}, 'left', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                <div><label style="font-size:9px; color:#999;">Width (%)</label><input type="number" placeholder="Def: 300px" value="${layout.width || ''}" oninput="updateProjectLayout(${i}, 'width', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                            </div>
                        </div>
                        <div style="background:#fff; padding:15px; border:1px solid #eee;">
                            <label style="color:#999; font-size:10px;">Layout Control (Gallery Images)</label>
                            <div class="row-inputs" style="gap:8px; margin-top:10px;">
                                <div><label style="font-size:9px; color:#999;">Top %</label><input type="number" placeholder="Def: 0" value="${galleryLayout.top || ''}" oninput="updateProjectGalleryLayout(${i}, 'top', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                <div><label style="font-size:9px; color:#999;">Left %</label><input type="number" placeholder="Def: 0" value="${galleryLayout.left || ''}" oninput="updateProjectGalleryLayout(${i}, 'left', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                                <div><label style="font-size:9px; color:#999;">Width %</label><input type="number" placeholder="Def: 100" value="${galleryLayout.width || ''}" oninput="updateProjectGalleryLayout(${i}, 'width', this.value)" style="padding:8px 0; font-size:12px; width:100%;"></div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top:15px;"><label>Description</label><textarea style="min-height:80px;" oninput="updateProject(${i}, 'description', this.value)">${proj.description || ''}</textarea></div>
                    <div style="margin-top:15px;"><label>Cover Image (List View)</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <img src="${proj.image}" style="height:40px; border-radius:4px;">
                            <input type="file" onchange="uploadFile(this, (path) => updateProject(${i}, 'image', path))">
                        </div>
                    </div>

                    <div style="margin-top:15px;"><label>Gallery Images (Detail View)</label>
                        <div class="gallery-grid" id="gallery-grid-${i}"></div>
                        <button class="btn" style="margin-top:5px; font-size:10px;" onclick="document.getElementById('gallery-upload-${i}').click()">+ ADD PHOTO</button>
                        <input type="file" id="gallery-upload-${i}" style="display:none" multiple onchange="uploadFilesBatch(this, (paths) => addGalleryImagesBatch(${i}, paths))">
                    </div>
                `;
                fragment.appendChild(div);

                // Render Gallery Grid (Optimized with lazy loading)
                const grid = div.querySelector(`#gallery-grid-${i}`);
                const galleryFragment = document.createDocumentFragment();

                (proj.gallery || []).forEach((imgItem, imgIndex) => {
                    // Normalize
                    const src = typeof imgItem === 'string' ? imgItem : imgItem.src;
                    const caption = (typeof imgItem === 'object' && imgItem.caption) ? imgItem.caption : "";

                    const thumb = document.createElement('div');
                    thumb.className = 'img-thumb-container';
                    thumb.style.height = 'auto';
                    thumb.draggable = true;
                    thumb.dataset.projIndex = i;
                    thumb.dataset.imgIndex = imgIndex;
                    thumb.innerHTML = `
                        <img src="${src}" draggable="false" loading="lazy">
                        <input type="text" class="image-caption-input" placeholder="ËæìÂÖ•ÁÖßÁâáÊèèËø∞..." value="${caption}">
                        <button class="img-remove" onclick="removeGalleryImage(${i}, ${imgIndex})">√ó</button>
                    `;

                    // Optimized drag events with minimal DOM operations
                    thumb.addEventListener('dragstart', (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', JSON.stringify({ proj: i, img: imgIndex }));
                        // Use requestAnimationFrame to ensure smooth CSS transitions
                        requestAnimationFrame(() => thumb.classList.add('dragging'));
                    });

                    thumb.addEventListener('dragend', () => {
                        thumb.classList.remove('dragging');
                        // Clean up all drag-over states
                        grid.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
                    });

                    thumb.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'move';
                        // Only add class if not already present (reduces DOM operations)
                        if (!thumb.classList.contains('drag-over')) {
                            thumb.classList.add('drag-over');
                        }
                    });

                    thumb.addEventListener('dragleave', (e) => {
                        // Only remove if we're actually leaving the element (not entering a child)
                        if (e.target === thumb || !thumb.contains(e.relatedTarget)) {
                            thumb.classList.remove('drag-over');
                        }
                    });

                    thumb.addEventListener('drop', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        thumb.classList.remove('drag-over');

                        const dragData = JSON.parse(e.dataTransfer.getData('text/plain'));
                        if (dragData.proj === i && dragData.img !== imgIndex) {
                            reorderGalleryImage(i, dragData.img, imgIndex);
                        }
                    });

                    // Attach debounced caption handler after DOM insertion
                    const captionInput = thumb.querySelector('.image-caption-input');
                    if (captionInput) {
                        captionInput.addEventListener('input', debounce((e) => {
                            updateGalleryCaption(i, imgIndex, e.target.value);
                        }, 500));
                    }

                    galleryFragment.appendChild(thumb);
                });

                // Batch insert all thumbnails
                grid.appendChild(galleryFragment);

                // Add drag hint
                const hint = document.createElement('div');
                hint.className = 'drag-hint';
                hint.textContent = 'üí° ÊãñÊãΩÁº©Áï•ÂõæÂèØË∞ÉÊï¥È°∫Â∫è';
                grid.parentNode.insertBefore(hint, grid.nextSibling);
            });

            // Performance: Batch append all projects at once
            container.appendChild(fragment);
        }

        function updateProject(index, key, val) {
            data.projects[index][key] = val;
            if (key === 'title' || key === 'image') renderProjects();
        }
        function updateProjectLayout(index, key, val) {
            if (!data.projects[index].layout) data.projects[index].layout = {};
            data.projects[index].layout[key] = val;
        }
        function updateProjectGalleryLayout(index, key, val) {
            if (!data.projects[index].gallery_layout) data.projects[index].gallery_layout = {};
            data.projects[index].gallery_layout[key] = val;
        }

        function addGalleryImage(idx, path) {
            if (!data.projects[idx].gallery) data.projects[idx].gallery = [];
            data.projects[idx].gallery.push(path);
            renderProjects();
        }

        function addGalleryImagesBatch(idx, paths) {
            if (!data.projects[idx].gallery) data.projects[idx].gallery = [];
            paths.forEach(p => data.projects[idx].gallery.push(p));
            renderProjects();
        }

        // Highly optimized reorder - pure DOM manipulation, no re-render
        function reorderGalleryImage(projIndex, fromIndex, toIndex) {
            const gallery = data.projects[projIndex].gallery;
            if (!gallery || fromIndex === toIndex) return;

            // Update data model
            const [movedItem] = gallery.splice(fromIndex, 1);
            gallery.splice(toIndex, 0, movedItem);

            // Direct DOM manipulation for instant visual feedback
            const grid = document.getElementById(`gallery-grid-${projIndex}`);
            if (!grid) return;

            const items = Array.from(grid.querySelectorAll('.img-thumb-container'));
            const movedEl = items[fromIndex];
            const targetEl = items[toIndex];

            if (!movedEl || !targetEl) return;

            // Move DOM element
            if (fromIndex < toIndex) {
                grid.insertBefore(movedEl, targetEl.nextSibling);
            } else {
                grid.insertBefore(movedEl, targetEl);
            }

            // Update all dataset indices and event handlers in a single pass
            const allItems = Array.from(grid.querySelectorAll('.img-thumb-container'));
            allItems.forEach((item, newIndex) => {
                item.dataset.imgIndex = newIndex;

                // Update caption input handler
                const captionInput = item.querySelector('.image-caption-input');
                if (captionInput) {
                    captionInput.setAttribute('oninput', `updateGalleryCaption(${projIndex}, ${newIndex}, this.value)`);
                }

                // Update remove button handler
                const removeBtn = item.querySelector('.img-remove');
                if (removeBtn) {
                    removeBtn.setAttribute('onclick', `removeGalleryImage(${projIndex}, ${newIndex})`);
                }
            });
        }

        // New Batch Upload Helper
        async function uploadFilesBatch(input, callback) {
            if (!input.files || input.files.length === 0) return;

            const paths = [];
            for (let i = 0; i < input.files.length; i++) {
                const file = input.files[i];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const res = await fetch('/api/upload', { method: 'POST', body: formData });
                    if (res.ok) {
                        const json = await res.json();
                        paths.push(json.filepath);
                    }
                } catch (e) {
                    console.error("Upload failed for file " + i, e);
                }
            }

            if (paths.length > 0) {
                callback(paths);
            }
            input.value = ''; // Reset
        }

        function updateGalleryCaption(projIndex, imgIndex, val) {
            let item = data.projects[projIndex].gallery[imgIndex];
            if (typeof item === 'string') {
                data.projects[projIndex].gallery[imgIndex] = { src: item, caption: val };
            } else {
                item.caption = val;
            }
        }

        function removeGalleryImage(idx, imgIdx) {
            data.projects[idx].gallery.splice(imgIdx, 1);
            renderProjects();
        }
        function addNewProject() {
            data.projects.unshift({ id: "new-" + Date.now(), title: "NEW PROJECT", year: "2026", description: "...", image: "images/placeholder.jpg", gallery: [] });
            renderProjects();
        }
        // Delete with double-click confirmation (avoids browser confirm() blocking)
        let deleteConfirmState = { index: -1, timeout: null };
        function deleteProject(index) {
            if (deleteConfirmState.index === index) {
                // Second click - actually delete
                clearTimeout(deleteConfirmState.timeout);
                data.projects.splice(index, 1);
                deleteConfirmState = { index: -1, timeout: null };
                renderProjects();
            } else {
                // First click - show warning
                clearTimeout(deleteConfirmState.timeout);
                deleteConfirmState.index = index;

                // Visual feedback
                const btn = event.target;
                btn.textContent = 'Á°ÆÂÆö?';
                btn.style.width = '50px';

                // Reset after 2 seconds
                deleteConfirmState.timeout = setTimeout(() => {
                    deleteConfirmState = { index: -1, timeout: null };
                    btn.textContent = 'X';
                    btn.style.width = '';
                }, 2000);
            }
        }
        function moveProject(index, dir) {
            const target = index + dir;
            if (target >= 0 && target < data.projects.length) {
                [data.projects[index], data.projects[target]] = [data.projects[target], data.projects[index]];
                renderProjects();
            }
        }

        // --- UTILS ---

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));

            document.getElementById('tab-' + tabId).classList.add('active');

            // Sync Sidebar Button State
            const btn = document.querySelector(`.tab-btn[onclick="switchTab('${tabId}')"]`);
            if (btn) btn.classList.add('active');

            // Update Page Title with translation
            const titles = { 'home': 'page.index', 'portfolios': 'page.collections', 'info': 'page.biography', 'contact': 'page.dialogue' };
            const pageTitle = document.querySelector('.page-title');
            if (pageTitle) pageTitle.innerText = t(titles[tabId] || 'page.index');
        }


        function updateContactLayout(side, key, val) {
            const prop = side === 'info' ? 'contact_info_layout' : 'contact_gallery_layout';
            if (!data.site[prop]) data.site[prop] = {};
            data.site[prop][key] = val;
        }

        // Toggle between random and fixed contact images
        function toggleContactImageMode(isRandom) {
            if (!data.site) data.site = {};
            data.site.contact_random_mode = isRandom;

            // Update UI
            const toggle = document.getElementById('contact-random-toggle');
            const label = document.getElementById('contact-mode-label');
            const fixedSection = document.getElementById('contact-fixed-section');

            if (toggle) toggle.checked = isRandom;
            if (label) label.textContent = isRandom ? 'üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè (Â∑≤ÂºÄÂêØ)' : 'üñºÔ∏è Âõ∫ÂÆöÂõæÁâáÊ®°Âºè';
            if (fixedSection) fixedSection.style.opacity = isRandom ? '0.4' : '1';

            // If switching to random, clear fixed images
            if (isRandom) {
                data.site.contact_fixed_images = [];
                renderContactImagesEditor();
            }
        }

        function renderContactImagesEditor() {
            const container = document.getElementById('contact-images-list');
            container.innerHTML = '';
            if (!data.site.contact_fixed_images) data.site.contact_fixed_images = [];

            // Update toggle state based on current mode
            const isRandom = data.site.contact_random_mode === true ||
                (data.site.contact_fixed_images.filter(s => s).length === 0);
            const toggle = document.getElementById('contact-random-toggle');
            const label = document.getElementById('contact-mode-label');
            const fixedSection = document.getElementById('contact-fixed-section');

            if (toggle) toggle.checked = isRandom;
            if (label) label.textContent = isRandom ? 'üì∑ ÈöèÊú∫Âà∑Êñ∞Ê®°Âºè (Â∑≤ÂºÄÂêØ)' : 'üñºÔ∏è Âõ∫ÂÆöÂõæÁâáÊ®°Âºè';
            if (fixedSection) fixedSection.style.opacity = isRandom ? '0.4' : '1';

            // Ensure 3 slots
            for (let i = 0; i < 3; i++) {
                const src = data.site.contact_fixed_images[i] || "";
                const div = document.createElement('div');
                div.style.flex = '1';
                div.innerHTML = `
                    <div style="background:#f5f5f5; height:100px; margin-bottom:8px; overflow:hidden; border:1px solid #eee;">
                        <img src="${src}" style="width:100%; height:100%; object-fit:cover; opacity:${src ? 1 : 0.3}">
                    </div>
                    ${src ? `<button class="btn btn-danger" style="width:100%; font-size:9px; padding:4px; margin-bottom:4px;" onclick="updateContactImage(${i}, '')">CLEAR</button>` : ''}
                    <button class="btn" style="width:100%; font-size:10px; padding:6px;" onclick="document.getElementById('c-upload-${i}').click()">${src ? 'REPLACE' : 'SELECT'}</button>
                    <input type="file" id="c-upload-${i}" style="display:none" onchange="uploadFile(this, (path) => updateContactImage(${i}, path))">
                 `;
                container.appendChild(div);
            }
        }

        function updateContactImage(index, path) {
            if (!data.site.contact_fixed_images) data.site.contact_fixed_images = [];
            if (path === '') {
                data.site.contact_fixed_images[index] = "";
                // If all empty, maybe clear array? Logic handles empty string as "random" if slots not filled, 
                // but script.js checks if array length > 0.
                // Actually script.js checks: if (siteInfo.contact_fixed_images && ... length > 0)
                // If [ "", "managed", "" ] -> it might show empty, managed, empty.
                // script.js logic: slice(0,3).map. 
                // I should ensure script.js handles empty strings in array by picking random? 
                // Current script.js: `targetImages = siteInfo.contact_fixed_images.slice(0, 3).map...`
                // It doesn't fallback per slot. It falls back if valid images array not found.
                // I will tell user: "Fill all 3 for best results or Clear All to go back to Random".
            } else {
                data.site.contact_fixed_images[index] = path;
            }
            // Remove trailing empty strings to fallback to random if all clear
            if (data.site.contact_fixed_images.every(s => !s)) data.site.contact_fixed_images = [];

            renderContactImagesEditor();
        }

        async function uploadFile(input, callback) {
            if (!input.files || !input.files[0]) return;
            const formData = new FormData();
            formData.append('file', input.files[0]);
            try {
                const res = await fetch('/api/upload', { method: 'POST', body: formData });
                const json = await res.json();
                if (json.status === 'success') callback(json.filepath);
                else alert('Upload failed');
            } catch (e) { alert('Error uploading'); }
        }

        async function saveData() {
            try {
                const res = await fetch('/api/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const json = await res.json();
                if (json.status === 'success') alert('Saved!');
                else alert('Error: ' + json.message);
            } catch (e) { alert('Connection Error'); }
        }
    </script>
</body>

</html>